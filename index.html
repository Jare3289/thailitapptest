<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ - The Literature Detective</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai+Looped:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            box-sizing: border-box;
            font-family: 'IBM Plex Sans Thai Looped', sans-serif;
        }
        
        /* Landing page background */
        #landingPage {
            background-image: url('https://img2.pic.in.th/pic/742215688----.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            position: relative;
        }
        
        #landingPage::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            z-index: 1;
            pointer-events: none;
            transition: background 0.3s ease;
        }
        
        #landingPage.user-logged-in::before {
            background: rgba(255, 255, 255, 0.85);
        }
        
        #landingPage > * {
            position: relative;
            z-index: 2;
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .modern-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        .word-to-find {
            color: #3b82f6;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }
        
        .word-to-find:hover {
            color: #1d4ed8;
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
            transform: scale(1.05);
        }
        
        .word-correct {
            color: #059669;
            font-weight: 700;
        }
        
        .word-incorrect {
            color: #dc2626;
            font-weight: 700;
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .poem-container {
            background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .poem-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899, #f59e0b);
        }
        
        .poem-text {
            font-size: 1.5rem;
            line-height: 1.8;
            font-weight: 400;
            font-family: 'IBM Plex Sans Thai Looped', sans-serif;
        }
        
        .kloang-container {
            line-height: 1.8;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1rem;
            overflow-x: auto;
        }

        .bart {
            display: flex;
            flex-wrap: nowrap;
            align-items: flex-start;
            margin-bottom: 0.8rem;
            white-space: nowrap;
            min-width: fit-content;
        }

        .wak-na {
            min-width: 280px; 
            max-width: 280px; 
            text-align: left;
            padding-right: 1.5rem;
            font-weight: 400;
            flex-shrink: 0;
            font-style: normal;
            white-space: nowrap;
            overflow: visible;
        }

        .wak-lang {
            padding-right: 0.5rem;
            padding-left: 1rem;
            font-weight: 400;
            font-style: normal;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .kam-sroi {
            font-style: normal;
            font-weight: 400;
            padding-left: 0.5rem;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .modern-button {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            font-weight: 600;
            border-radius: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            border: none;
        }
        
        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.4);
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
        }
        
        .modern-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .modern-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 15px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .modern-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
            background: white;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            height: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            border-radius: 25px;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .step-indicator {
            background: rgba(59, 130, 246, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1rem;
        }
        
        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .step-active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 8px 15px -3px rgba(59, 130, 246, 0.4);
            transform: scale(1.1);
        }
        
        .step-completed {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 8px 15px -3px rgba(16, 185, 129, 0.4);
        }
        
        .step-inactive {
            background: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.7);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            font-weight: 600;
            z-index: 1000;
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification-success {
            background: rgba(16, 185, 129, 0.9);
            color: white;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .notification-error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .floating-elements {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        
        .floating-element {
            position: absolute;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg);
                opacity: 0.1;
            }
            50% { 
                transform: translateY(-20px) rotate(180deg);
                opacity: 0.3;
            }
        }
        
        .tooltip-modern {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .badge-modern {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(-50px);
            }
            50% {
                opacity: 1;
                transform: scale(1.05) translateY(-10px);
            }
            70% {
                transform: scale(0.95) translateY(0);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .animate-bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .hero-text {
            text-shadow: 2px 2px 20px rgba(0,0,0,0.3);
        }
        
        .landing-feature {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .landing-feature:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        /* üì± Mobile Portrait Styles */
        @media (max-width: 768px) and (orientation: portrait) {
            .poem-text {
                font-size: 1.1rem !important;
                line-height: 1.6 !important;
            }
            
            .hero-text {
                font-size: 2rem !important;
            }
            
            .modern-card {
                margin: 0.5rem !important;
                padding: 1rem !important;
            }
            
            .modern-button {
                padding: 0.75rem 1.5rem !important;
                font-size: 1rem !important;
            }
            
            .step-indicator {
                padding: 0.5rem !important;
            }
            
            .step-circle {
                width: 35px !important;
                height: 35px !important;
                font-size: 0.9rem !important;
            }
            
            .notification {
                top: 1rem !important;
                right: 1rem !important;
                left: 1rem !important;
                width: auto !important;
            }
            
            .tooltip-modern {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                max-width: 90vw !important;
                max-height: 80vh !important;
                overflow-y: auto !important;
            }

            .kloang-container {
                padding: 0 0.5rem !important;
                font-size: 0.9rem !important;
                max-width: 100% !important;
                overflow-x: auto !important;
            }
            
            .bart {
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                margin-bottom: 0.8rem !important;
                padding: 0.3rem !important;
                background: rgba(255,255,255,0.1) !important;
                border-radius: 8px !important;
                white-space: nowrap !important;
                min-width: fit-content !important;
            }
            
            .wak-na {
                min-width: 200px !important;
                max-width: 200px !important;
                text-align: left !important;
                padding-right: 1rem !important;
                margin-bottom: 0 !important;
                font-size: 0.9rem !important;
                line-height: 1.4 !important;
                white-space: nowrap !important;
                flex-shrink: 0 !important;
            }
            
            .wak-lang {
                padding-right: 0.3rem !important;
                padding-left: 0.8rem !important;
                font-size: 0.9rem !important;
                white-space: nowrap !important;
                flex-shrink: 0 !important;
            }
            
            .kam-sroi {
                padding-left: 0.5rem !important;
                font-size: 0.9rem !important;
                color: rgba(0,0,0,0.7) !important;
                white-space: nowrap !important;
                flex-shrink: 0 !important;
            }

            .progress-container {
                padding: 0.5rem !important;
                margin-bottom: 1rem !important;
            }

            #header {
                margin-top: 0px !important;
            }

            #mainContent {
                padding: 1rem !important;
                margin-top: 0px !important;
                padding-top: 1rem !important;
            }
        }

        /* Header Sticky Positioning */
        #header {
            position: sticky !important;
            top: 0px !important;
            z-index: 50 !important;
        }

        /* Main Content Proper Spacing */
        #mainContent {
            padding-top: 2rem !important;
            min-height: calc(100vh - 200px) !important;
        }

        /* üì± Mobile Landscape Styles - Perfect fit without scrollbars */
        @media (max-width: 1024px) and (orientation: landscape) and (max-height: 768px) {
            html, body {
                overflow: hidden !important;
                height: 100vh !important;
                margin: 0 !important;
                padding: 0 !important;
                position: fixed !important;
                width: 100vw !important;
            }
            
            /* Landing page - perfect fit */
            #landingPage {
                height: 100vh !important;
                overflow: hidden !important;
                padding: 0.25rem !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
            }
            
            #landingPage .grid {
                height: 100vh !important;
                gap: 0.5rem !important;
                overflow: hidden !important;
            }
            
            #landingPage .modern-card {
                padding: 0.5rem !important;
                height: 100vh !important;
                overflow-y: auto !important;
                max-height: 100vh !important;
            }
            
            #landingPage h1 {
                font-size: 1.2rem !important;
                margin-bottom: 0.25rem !important;
            }
            
            #landingPage p {
                font-size: 0.7rem !important;
                margin-bottom: 0.25rem !important;
            }
            
            #landingPage .text-3xl {
                font-size: 1rem !important;
            }
            
            #landingPage .text-2xl {
                font-size: 0.9rem !important;
            }
            
            #landingPage .text-xl {
                font-size: 0.8rem !important;
            }
            
            #landingPage .text-lg {
                font-size: 0.7rem !important;
            }
            
            #landingPage .py-4 {
                padding-top: 0.25rem !important;
                padding-bottom: 0.25rem !important;
            }
            
            #landingPage .px-6 {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            
            #landingPage .mb-4 {
                margin-bottom: 0.25rem !important;
            }
            
            #landingPage .mb-6 {
                margin-bottom: 0.5rem !important;
            }
            
            #landingPage .p-4 {
                padding: 0.5rem !important;
            }
            
            #landingPage .p-6 {
                padding: 0.5rem !important;
            }
            
            #landingPage .p-8 {
                padding: 0.5rem !important;
            }
            
            #landingPage .space-y-4 > * + * {
                margin-top: 0.25rem !important;
            }
            
            #landingPage .grid-cols-3 {
                gap: 0.25rem !important;
            }
            
            #landingPage .grid-cols-2 {
                gap: 0.25rem !important;
            }
            
            /* Header - ultra compact */
            #header {
                padding: 0.1rem 0.25rem !important;
                position: sticky !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 50 !important;
                height: 60px !important;
                overflow: hidden !important;
            }
            
            #header h1 {
                font-size: 0.8rem !important;
                margin-bottom: 0.05rem !important;
            }
            
            #header p {
                font-size: 0.6rem !important;
                margin-bottom: 0.05rem !important;
            }
            
            #header .modern-card {
                margin: 0 !important;
                padding: 0.1rem 0.25rem !important;
            }
            
            #header .text-2xl {
                font-size: 0.7rem !important;
            }
            
            #header .text-xl {
                font-size: 0.6rem !important;
            }
            
            .step-indicator {
                padding: 0.1rem !important;
                margin-top: 0.05rem !important;
            }
            
            .step-circle {
                width: 15px !important;
                height: 15px !important;
                font-size: 0.5rem !important;
            }
            
            /* Main content - perfect fit with proper spacing */
            #mainContent {
                padding: 0.5rem !important;
                padding-top: 1rem !important;
                overflow-y: auto !important;
                height: calc(100vh - 60px) !important;
                margin-top: 0 !important;
                display: flex !important;
                align-items: flex-start !important;
                justify-content: center !important;
            }
            
            #mainContent .modern-card {
                margin: 0 !important;
                padding: 0.5rem !important;
                margin-top: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                max-height: calc(100vh - 60px) !important;
                overflow-y: auto !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: flex-start !important;
                align-items: center !important;
            }
            
            /* Typography ultra compact */
            .poem-text {
                font-size: 0.6rem !important;
                line-height: 1.1 !important;
            }
            
            .poem-container {
                padding: 0.25rem !important;
                margin-bottom: 0.25rem !important;
            }
            
            .kloang-container {
                padding: 0 0.5rem !important;
                font-size: 0.6rem !important;
                max-width: 100% !important;
                margin: 0 auto !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                text-align: center !important;
            }
            
            .bart {
                margin-bottom: 0.2rem !important;
                padding: 0.2rem !important;
                display: flex !important;
                flex-direction: row !important;
                justify-content: center !important;
                align-items: center !important;
                text-align: center !important;
                width: 100% !important;
                flex-wrap: nowrap !important;
            }
            
            .wak-na {
                min-width: 120px !important;
                max-width: 120px !important;
                padding-right: 0.5rem !important;
                text-align: center !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
            }
            
            /* Buttons ultra compact */
            .modern-button {
                padding: 0.2rem 0.4rem !important;
                font-size: 0.6rem !important;
            }
            
            .badge-modern {
                padding: 0.05rem 0.2rem !important;
                font-size: 0.5rem !important;
            }
            
            /* Grid ultra compact */
            .grid {
                gap: 0.1rem !important;
            }
            
            .grid-cols-1 {
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
            }
            
            .grid-cols-3 {
                gap: 0.1rem !important;
            }
            
            /* Text sizes ultra small */
            h2 {
                font-size: 0.8rem !important;
                margin-bottom: 0.1rem !important;
            }
            
            h3 {
                font-size: 0.7rem !important;
                margin-bottom: 0.1rem !important;
            }
            
            h4 {
                font-size: 0.6rem !important;
                margin-bottom: 0.1rem !important;
            }
            
            p, div, span {
                font-size: 0.6rem !important;
                line-height: 1.0 !important;
            }
            
            /* Spacing ultra compact */
            .space-y-6 > * + * {
                margin-top: 0.1rem !important;
            }
            
            .space-y-8 > * + * {
                margin-top: 0.1rem !important;
            }
            
            .space-y-10 > * + * {
                margin-top: 0.2rem !important;
            }
            
            /* Margins and padding ultra small */
            .mb-6, .mb-8, .mb-10 {
                margin-bottom: 0.1rem !important;
            }
            
            .mt-6, .mt-8, .mt-10 {
                margin-top: 0.1rem !important;
            }
            
            .p-6, .p-8, .p-10 {
                padding: 0.1rem !important;
            }
            
            .p-4 {
                padding: 0.1rem !important;
            }
            
            /* Form elements compact */
            textarea {
                min-height: 30px !important;
                padding: 0.2rem !important;
                font-size: 0.6rem !important;
            }
            
            input {
                padding: 0.2rem !important;
                font-size: 0.6rem !important;
            }
            
            /* Images compact */
            .aspect-video {
                aspect-ratio: 16/9 !important;
                max-height: 60px !important;
            }
            
            /* Notifications */
            .notification {
                top: 0.1rem !important;
                right: 0.1rem !important;
                font-size: 0.5rem !important;
                padding: 0.1rem 0.25rem !important;
            }
            
            /* Hide unnecessary elements */
            .md\\:hidden {
                display: none !important;
            }
            
            .hidden.md\\:flex {
                display: none !important;
            }
            
            /* Mobile step text only */
            .md\\:hidden {
                display: block !important;
                font-size: 0.5rem !important;
            }
            
            /* Tooltip adjustments */
            .tooltip-modern {
                max-width: 80vw !important;
                max-height: 60vh !important;
                padding: 0.25rem !important;
            }
            
            .tooltip-modern h3 {
                font-size: 0.6rem !important;
            }
            
            .tooltip-modern input {
                padding: 0.2rem !important;
                font-size: 0.6rem !important;
            }
            
            .tooltip-modern button {
                padding: 0.2rem 0.3rem !important;
                font-size: 0.6rem !important;
            }
            
            /* Final score page adjustments */
            .text-4xl, .text-5xl {
                font-size: 1rem !important;
            }
            
            .text-3xl {
                font-size: 0.9rem !important;
            }
            
            /* Certificate button */
            #mainContent button {
                width: 100% !important;
                margin-bottom: 0.1rem !important;
            }
            
            /* Remove all scrollbars completely */
            * {
                scrollbar-width: none !important;
                -ms-overflow-style: none !important;
            }
            
            *::-webkit-scrollbar {
                display: none !important;
            }
        }

        /* üìü Tablet Styles */
        @media (max-width: 1024px) and (min-width: 769px) and (orientation: portrait) {
            .poem-text {
                font-size: 1.3rem !important;
            }
            
            .modern-card {
                padding: 1.5rem !important;
            }

            .kloang-container {
                max-width: 500px !important;
            }
            
            .wak-na {
                min-width: 200px !important;
                max-width: 200px !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
    <!-- Floating Background Elements -->
    <div class="floating-elements">
        <div class="floating-element text-6xl" style="top: 10%; left: 10%; animation-delay: 0s;">üìö</div>
        <div class="floating-element text-4xl" style="top: 20%; right: 15%; animation-delay: 1s;">‚ú®</div>
        <div class="floating-element text-5xl" style="bottom: 20%; left: 20%; animation-delay: 2s;">üîç</div>
        <div class="floating-element text-3xl" style="bottom: 30%; right: 25%; animation-delay: 3s;">üí≠</div>
    </div>

    <!-- Landing Page -->
    <div id="landingPage" class="min-h-screen bg-gray-50 flex items-center justify-center p-2 md:p-4 relative overflow-hidden">
        <div class="max-w-6xl mx-auto relative z-10 w-full">
            <!-- Main Content Grid -->
            <div class="grid lg:grid-cols-2 gap-4 md:gap-8 items-center min-h-screen py-4">
                <!-- Left Column - Hero Content -->
                <div class="text-center lg:text-left flex flex-col justify-center h-full py-8">
                    <div class="mb-6">
                        <div class="text-6xl lg:text-7xl mb-4">üìö</div>
                        <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 mb-4">
                            ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ
                        </h1>
                        <p class="text-base md:text-lg lg:text-xl text-gray-600 mb-6">
                            ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ‡πÑ‡∏ó‡∏¢‡πÅ‡∏ö‡∏ö‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö
                        </p>
                        
                        <!-- Feature Highlights -->
                        <div class="flex flex-wrap justify-center lg:justify-start gap-4 text-base mb-6">
                            <div class="flex items-center gap-2 bg-blue-100 px-4 py-2 rounded-full">
                                <span class="text-2xl">üîç</span>
                                <span class="font-semibold text-blue-800">‡∏™‡∏∑‡∏ö‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</span>
                            </div>
                            <div class="flex items-center gap-2 bg-purple-100 px-4 py-2 rounded-full">
                                <span class="text-2xl">üí≠</span>
                                <span class="font-semibold text-purple-800">‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</span>
                            </div>
                            <div class="flex items-center gap-2 bg-green-100 px-4 py-2 rounded-full">
                                <span class="text-2xl">üìñ</span>
                                <span class="font-semibold text-green-800">‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°</span>
                            </div>
                        </div>
                        
                        <!-- Login Section -->
                        <div id="loginSection" class="mb-6">
                            <div class="bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg border border-white border-opacity-30 rounded-2xl p-4 mb-4">
                                <div class="flex items-center justify-center gap-4 mb-4">
                                    <span class="text-2xl">üë§</span>
                                    <h3 class="text-xl font-bold text-gray-900">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
                                </div>
                                <p class="text-gray-700 text-center mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
                                
                                <div id="loginButtons" class="space-y-4">
                                    <div class="grid grid-cols-3 gap-2">
                                        <button onclick="showStudentForm()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-2 rounded-xl transition-all duration-200 text-sm">
                                            üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                                        </button>
                                        
                                        <button onclick="showLoginForm()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-2 rounded-xl transition-all duration-200 text-sm">
                                            üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                                        </button>
                                        
                                        <button id="startGameBtn" onclick="startGame()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 px-2 rounded-xl transition-all duration-200 text-sm disabled:bg-gray-400 disabled:cursor-not-allowed disabled:opacity-50 transform hover:scale-105 shadow-lg enabled:shadow-2xl enabled:animate-pulse" disabled>
                                            ‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Student Registration Form -->
                                <div id="studentForm" class="hidden space-y-4">
                                    <div class="text-center mb-4">
                                        <h4 class="text-lg font-bold text-gray-900">üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                                        <p class="text-sm text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                                            <input type="text" id="studentName" class="w-full modern-input p-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô *</label>
                                            <input type="text" id="studentId" class="w-full modern-input p-3" placeholder="12345" required>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">‡∏ä‡∏±‡πâ‡∏ô *</label>
                                            <select id="studentGrade" class="w-full modern-input p-3" required>
                                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
                                                <option value="‡∏°.1">‡∏°.1</option>
                                                <option value="‡∏°.2">‡∏°.2</option>
                                                <option value="‡∏°.3">‡∏°.3</option>
                                                <option value="‡∏°.4">‡∏°.4</option>
                                                <option value="‡∏°.5">‡∏°.5</option>
                                                <option value="‡∏°.6">‡∏°.6</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">‡∏´‡πâ‡∏≠‡∏á *</label>
                                            <input type="text" id="studentRoom" class="w-full modern-input p-3" placeholder="1" required>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà *</label>
                                            <input type="text" id="studentNumber" class="w-full modern-input p-3" placeholder="1" required>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
                                        <input type="tel" id="studentPhone" class="w-full modern-input p-3" placeholder="0812345678" required>
                                        <p class="text-xs text-gray-500 mt-1">‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                                    </div>
                                    
                                    <div class="flex gap-3 mt-6">
                                        <button onclick="hideStudentForm()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                        </button>
                                        <button onclick="registerStudent()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Student Login Form -->
                                <div id="loginForm" class="hidden space-y-4">
                                    <div class="text-center mb-4">
                                        <h4 class="text-lg font-bold text-gray-900">üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h4>
                                        <p class="text-sm text-gray-600">‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</p>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                        <input type="text" id="loginStudentId" class="w-full modern-input p-3" placeholder="12345">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                        <input type="tel" id="loginPhone" class="w-full modern-input p-3" placeholder="0812345678">
                                    </div>
                                    
                                    <div class="flex gap-3 mt-6">
                                        <button onclick="hideLoginForm()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                        </button>
                                        <button onclick="loginStudent()" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="userInfo" class="hidden text-center">
                                    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4 mb-4">
                                        <div class="flex items-center justify-center gap-3 mb-3">
                                            <img id="userPhoto" src="" alt="Profile" class="w-12 h-12 rounded-full border-2 border-green-300">
                                            <div>
                                                <p class="font-bold text-green-900" id="userName"></p>
                                                <p class="text-sm text-green-700" id="userDetails"></p>
                                            </div>
                                        </div>
                                        <div class="text-xs text-green-600" id="userStats"></div>
                                    </div>
                                    <button onclick="signOutUser()" class="text-red-600 hover:text-red-700 font-semibold">
                                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                                    </button>
                                </div>
                            </div>
                        </div>
                        

                    </div>
                </div>
                
                <!-- Right Column - Mission Info -->
                <div class="modern-card rounded-3xl p-4 md:p-6 h-full overflow-y-auto">
                    <div class="mb-4">
                        <h2 class="text-xl md:text-2xl lg:text-3xl font-bold text-gray-900 mb-2">
                            ‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û
                        </h2>
                        <p class="text-base md:text-lg lg:text-xl text-gray-600">‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏û‡∏á‡∏®‡∏≤‡∏ß‡∏î‡∏≤‡∏£ - ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200 rounded-2xl p-4 mb-4">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="text-3xl">üéØ</span>
                            <div>
                                <h3 class="text-lg font-bold text-blue-900">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h3>
                                <p class="text-blue-800 text-sm">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏¢‡∏≤‡∏Å 5 ‡∏Ñ‡∏≥</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div class="bg-white bg-opacity-50 rounded-xl p-3">
                                <div class="text-xl font-bold text-blue-600">5</div>
                                <div class="text-blue-700 text-xs">‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</div>
                            </div>
                            <div class="bg-white bg-opacity-50 rounded-xl p-3">
                                <div class="text-xl font-bold text-green-600">100+</div>
                                <div class="text-green-700 text-xs">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                            </div>
                            <div class="bg-white bg-opacity-50 rounded-xl p-3">
                                <div class="text-xl font-bold text-purple-600">5</div>
                                <div class="text-purple-700 text-xs">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Features List -->
                    <div class="space-y-3 mb-4">
                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                            <div class="text-2xl">üîç</div>
                            <div>
                                <h4 class="font-bold text-gray-900 text-sm">‡∏™‡∏∑‡∏ö‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</h4>
                                <p class="text-gray-600 text-xs">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                            <div class="text-2xl">üí≠</div>
                            <div>
                                <h4 class="font-bold text-gray-900 text-sm">‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ & ‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°</h4>
                                <p class="text-gray-600 text-xs">‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏Å‡πâ‡∏ß‡∏™‡∏°‡∏±‡∏¢‡πÉ‡∏´‡∏°‡πà</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                            <div class="text-2xl">üñºÔ∏è</div>
                            <div>
                                <h4 class="font-bold text-gray-900 text-sm">‡πÄ‡∏õ‡∏¥‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á</h4>
                                <p class="text-gray-600 text-xs">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏à‡∏£‡∏¥‡∏á</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ranking System -->
                    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 border-2 border-yellow-200 rounded-2xl p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">üèÜ</span>
                            <h3 class="text-lg font-bold text-yellow-900">‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</h3>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-2">
                            <div class="bg-white bg-opacity-60 rounded-xl p-2 text-center">
                                <div class="text-base mb-1">ü•á</div>
                                <div class="font-bold text-yellow-800 text-xs">‡∏ô‡∏±‡∏Å‡∏™‡∏∑‡∏ö‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô</div>
                                <div class="text-xs text-yellow-700">1000+ ‡πÅ‡∏ï‡πâ‡∏°</div>
                            </div>
                            <div class="bg-white bg-opacity-60 rounded-xl p-2 text-center">
                                <div class="text-base mb-1">ü•à</div>
                                <div class="font-bold text-gray-700 text-xs">‡∏ô‡∏±‡∏Å‡∏™‡∏∑‡∏ö‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç</div>
                                <div class="text-xs text-gray-600">500+ ‡πÅ‡∏ï‡πâ‡∏°</div>
                            </div>
                            <div class="bg-white bg-opacity-60 rounded-xl p-2 text-center">
                                <div class="text-base mb-1">ü•â</div>
                                <div class="font-bold text-orange-700 text-xs">‡∏ô‡∏±‡∏Å‡∏™‡∏∑‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î</div>
                                <div class="text-xs text-orange-600">200+ ‡πÅ‡∏ï‡πâ‡∏°</div>
                            </div>
                            <div class="bg-white bg-opacity-60 rounded-xl p-2 text-center">
                                <div class="text-base mb-1">üåü</div>
                                <div class="font-bold text-blue-700 text-xs">‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà</div>
                                <div class="text-xs text-blue-600">0+ ‡πÅ‡∏ï‡πâ‡∏°</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Header Dashboard (Hidden initially) -->
    <header id="header" class="bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 shadow-lg border-b border-blue-300 p-2 md:p-3 hidden overflow-hidden">
        <!-- Background decoration -->
        <div class="absolute inset-0 opacity-10">
            <div class="absolute top-2 left-2 text-2xl animate-pulse">üìö</div>
            <div class="absolute top-2 right-2 text-2xl animate-pulse" style="animation-delay: 1s;">‚ú®</div>
            <div class="absolute bottom-2 left-2 text-2xl animate-pulse" style="animation-delay: 2s;">üîç</div>
            <div class="absolute bottom-2 right-2 text-2xl animate-pulse" style="animation-delay: 3s;">üí≠</div>
        </div>
        
        <div class="max-w-6xl mx-auto relative z-10">
            <!-- Top Row: Title and Controls -->
            <div class="flex flex-col lg:flex-row justify-between items-center gap-2 md:gap-3 mb-2">
                <div class="text-center lg:text-left">
                    <h1 class="text-xl md:text-2xl font-bold text-white mb-1">
                        üìö ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ
                    </h1>
                    <p class="text-white text-sm md:text-base opacity-90">‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ‡πÑ‡∏ó‡∏¢‡πÅ‡∏ö‡∏ö‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö</p>
                    <div id="headerUserName" class="mt-1 text-xs text-slate-200 font-semibold hidden cursor-pointer hover:text-slate-100 transition-colors duration-200" onclick="showUserMenu()">
                        üë§ <span id="currentUserName">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span> ‚ñº
                    </div>
                </div>
                
                <!-- Player Profile -->
                <div class="flex items-center gap-2 md:gap-4">
                    <div class="bg-white bg-opacity-20 rounded-xl px-3 md:px-4 py-2 md:py-3 border border-white border-opacity-30">
                        <div class="flex items-center gap-2 md:gap-4">
                            <div class="text-center">
                                <p class="text-slate-100 font-bold text-lg md:text-xl"><span id="playerExp">0</span> ‡πÅ‡∏ï‡πâ‡∏°</p>
                                <p class="text-xs text-white opacity-75">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°</p>
                            </div>
                            <div class="w-px h-6 md:h-8 bg-white bg-opacity-30"></div>
                            <div class="text-center">
                                <p class="bg-gradient-to-r from-blue-400 to-indigo-400 text-white px-2 py-1 rounded-full font-bold text-xs"><span id="playerRank">‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà</span></p>
                                <p class="text-xs text-white opacity-75 mt-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Game Menu -->
                    <div class="flex gap-1">
                        <button id="backBtn" onclick="goBack()" class="bg-white bg-opacity-20 px-2 md:px-3 py-1 md:py-2 text-xs text-white hover:bg-white hover:bg-opacity-30 rounded-lg hidden transition-all duration-200">
                            ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                        </button>
                        <button onclick="showLandingPage()" class="bg-white bg-opacity-20 px-2 md:px-3 py-1 md:py-2 text-xs text-white hover:bg-white hover:bg-opacity-30 rounded-lg transition-all duration-200 border border-white border-opacity-30">
                            üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                        </button>
                        <button onclick="showLandingPage()" class="bg-white bg-opacity-20 px-2 md:px-3 py-1 md:py-2 text-xs text-white hover:bg-white hover:bg-opacity-30 rounded-lg transition-all duration-200 border border-white border-opacity-30">
                            üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mb-2">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-white font-semibold text-xs md:text-sm">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
                    <span id="progressText" class="text-white font-bold text-xs md:text-sm">0%</span>
                </div>
                <div class="bg-white bg-opacity-30 rounded-full h-2 overflow-hidden">
                    <div id="mainProgressFill" class="bg-gradient-to-r from-yellow-400 to-orange-400 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>
        
        <!-- Step Indicators -->
        <div class="max-w-6xl mx-auto mt-2 md:mt-3">
            <div class="glass-card rounded-2xl p-2 border border-white border-opacity-30">
                <div class="flex justify-center items-center gap-1 md:gap-2 mb-2">
                    <div id="step-1" class="step-circle step-active">1</div>
                    <div class="w-2 md:w-4 h-1 bg-gradient-to-r from-white to-transparent bg-opacity-40 rounded-full"></div>
                    <div id="step-2" class="step-circle step-inactive">2</div>
                    <div class="w-2 md:w-4 h-1 bg-gradient-to-r from-white to-transparent bg-opacity-40 rounded-full"></div>
                    <div id="step-3" class="step-circle step-inactive">3</div>
                    <div class="w-2 md:w-4 h-1 bg-gradient-to-r from-white to-transparent bg-opacity-40 rounded-full"></div>
                    <div id="step-4" class="step-circle step-inactive">4</div>
                    <div class="w-2 md:w-4 h-1 bg-gradient-to-r from-white to-transparent bg-opacity-40 rounded-full"></div>
                    <div id="step-5" class="step-circle step-inactive">5</div>
                    <div class="w-2 md:w-4 h-1 bg-gradient-to-r from-white to-transparent bg-opacity-40 rounded-full"></div>
                    <div id="step-6" class="step-circle step-inactive">6</div>
                </div>
                <div class="hidden md:flex justify-center items-center gap-2 text-white font-semibold text-xs opacity-90">
                    <span>üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</span>
                    <span>üìñ ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏•‡∏á</span>
                    <span>‚úçÔ∏è ‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ & ‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°</span>
                    <span>üñºÔ∏è ‡πÄ‡∏õ‡∏¥‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á</span>
                    <span>üìù ‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô</span>
                    <span>üèÜ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</span>
                </div>
                <div class="md:hidden text-center text-white font-semibold text-xs opacity-90">
                    <span id="currentStepText">üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="mainContent" class="max-w-6xl mx-auto p-3 md:p-6 hidden">
        <!-- Content will be dynamically rendered here -->
    </main>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // Firebase Configuration - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const firebaseConfig = {
            apiKey: "AIzaSyCgIPCTpBY4Wwtk7kF4oViRVwJ7IAT77N0",
            authDomain: "thailit-d1633.firebaseapp.com",
            projectId: "thailit-d1633",
            storageBucket: "thailit-d1633.firebasestorage.app",
            messagingSenderId: "769056016001",
            appId: "1:769056016001:web:1e0d2eb6118a405120af80",
            measurementId: "G-XR94B0EBD6"
        };

        // Initialize Firebase
        let db = null;
        let auth = null;
        let analytics = null;
        
        try {
            // Initialize Firebase App
            firebase.initializeApp(firebaseConfig);
            
            // Initialize services
            db = firebase.firestore();
            auth = firebase.auth();
            
            // Initialize Analytics (optional)
            if (typeof firebase.analytics === 'function') {
                analytics = firebase.analytics();
                console.log('Firebase Analytics initialized');
            }
            
            // Configure Firestore settings
            db.settings({
                cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
            });
            
            // Enable offline persistence
            db.enablePersistence({ synchronizeTabs: true })
                .then(() => {
                    console.log('Firestore offline persistence enabled');
                })
                .catch((err) => {
                    console.log('Firestore offline persistence failed:', err);
                });
            
            console.log('üî• Firebase initialized successfully with real database!');
            showNotification('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üî•', 'success');
            
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á', 'error');
        }

        // Game State Management
        const gameState = {
            currentStep: 1,
            translatedWords: {},
            incorrectWords: {},
            wordAttempts: {}, // Track number of incorrect attempts per word
            imaginationText: '',
            interpretationText: '',
            comprehensionScore: 0,
            startTime: Date.now(),
            selectedWord: null,
            userId: null,
            gameId: null,
            stepHistory: []
        };

        const playerProfile = {
            exp: 0,
            rank: '‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà',
            totalGamesPlayed: 0,
            bestScore: 0,
            level: 1,
            expToNextLevel: 100
        };

        // Mission Data
        const MISSION_DATA = {
            MISSION_01: {
                title: "‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û - ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏û‡∏á‡∏®‡∏≤‡∏ß‡∏î‡∏≤‡∏£",
                historicalBackground: {
                    title: "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå: ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢",
                    content: `
                        <div class="space-y-6">
                            <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 rounded-2xl p-6">
                                <h4 class="text-xl font-bold text-amber-900 mb-4">üëë ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢</h4>
                                <p class="text-amber-800 leading-relaxed">
                                    ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢ ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏£‡∏£‡∏î‡∏¥ (‡∏û‡∏£‡∏∞‡∏£‡∏≤‡πÄ‡∏°‡∏®‡∏ß‡∏£) ‡πÅ‡∏´‡πà‡∏á‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ 
                                    ‡∏ó‡∏£‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÑ‡∏ó‡∏¢ ‡∏ó‡∏µ‡πà‡∏ó‡∏£‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô
                                </p>
                            </div>
                            
                            <div class="bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-200 rounded-2xl p-6">
                                <h4 class="text-xl font-bold text-red-900 mb-4">‚öîÔ∏è ‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°‡∏Å‡∏±‡∏ö‡∏û‡∏°‡πà‡∏≤ (‡∏û.‡∏®. 2091)</h4>
                                <p class="text-red-800 leading-relaxed">
                                    ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏õ‡∏£ (‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ï‡∏∞‡∏ö‡∏¥‡∏á‡∏ä‡πÄ‡∏ß‡∏ï‡∏µ) ‡πÅ‡∏´‡πà‡∏á‡∏û‡∏°‡πà‡∏≤‡∏¢‡∏Å‡∏ó‡∏±‡∏û‡∏°‡∏≤‡∏ï‡∏µ‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ 
                                    ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢‡∏ó‡∏£‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏´‡∏≤‡∏£ ‡∏Ç‡∏µ‡πà‡∏ä‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏≤‡∏°‡∏µ
                                </p>
                            </div>
                            
                            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-2xl p-6">
                                <h4 class="text-xl font-bold text-purple-900 mb-4">üêò ‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç</h4>
                                <p class="text-purple-800 leading-relaxed">
                                    ‡πÉ‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏ö ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢‡∏ó‡∏£‡∏á‡∏Ç‡∏µ‡πà‡∏ä‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏≤‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ 
                                    ‡πÅ‡∏ï‡πà‡∏ó‡∏£‡∏á‡∏ñ‡∏π‡∏Å‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏õ‡∏£‡πÉ‡∏ä‡πâ‡∏á‡πâ‡∏≤‡∏ß‡∏ü‡∏±‡∏ô‡∏à‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå‡∏ö‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ä‡πâ‡∏≤‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏•‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô
                                </p>
                            </div>
                            
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl p-6">
                                <h4 class="text-xl font-bold text-green-900 mb-4">üìú ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏û‡∏á‡∏®‡∏≤‡∏ß‡∏î‡∏≤‡∏£</h4>
                                <p class="text-green-800 leading-relaxed">
                                    ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏û‡∏á‡∏®‡∏≤‡∏ß‡∏î‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ 
                                    ‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏ç‡∏û‡∏£‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç
                                </p>
                            </div>
                        </div>
                    `
                },
                poem: `<div class="kloang-container">
                    <!-- ‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà ‡πë: ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤ 5 ‡∏Ñ‡∏≥ + ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏á 2 ‡∏Ñ‡∏≥ -->
                    <div class="bart">
                        <span class="wak-na">‡πè <span class="word-to-find" data-word="‡∏ô‡∏á‡∏Ñ‡∏£‡∏≤‡∏ç">‡∏ô‡∏á‡∏Ñ‡∏£‡∏≤‡∏ç</span>‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏≠‡∏Å‡πÅ‡∏Å‡πâ‡∏ß</span>
                        <span class="wak-lang">‡∏Å‡∏£‡∏∞‡∏©‡∏±‡∏ï‡∏£‡∏µ‡∏¢‡πå</span>
                    </div>

                    <!-- ‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà ‡πí: ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤ 5 ‡∏Ñ‡∏≥ + ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏á 2 ‡∏Ñ‡∏≥ -->
                    <div class="bart">
                        <span class="wak-na"><span class="word-to-find" data-word="‡∏°‡∏≤‡∏ô">‡∏°‡∏≤‡∏ô</span>‡∏°‡∏ô‡∏±‡∏™<span class="word-to-find" data-word="‡∏Å‡∏±‡∏ï‡πÄ‡∏ß‡∏ó‡∏µ">‡∏Å‡∏±‡∏ï‡πÄ‡∏ß‡∏ó‡∏µ</span></span>
                        <span class="wak-lang">‡∏¢‡∏¥‡πà‡∏á‡∏•‡πâ‡∏≥</span>
                    </div>

                    <!-- ‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà ‡πì: ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤ 5 ‡∏Ñ‡∏≥ + ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏á 2 ‡∏Ñ‡∏≥ + ‡∏Ñ‡∏≥‡∏™‡∏£‡πâ‡∏≠‡∏¢ 2 ‡∏Ñ‡∏≥ -->
                    <div class="bart">
                        <span class="wak-na">‡πÄ‡∏Å‡∏£‡∏á‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏≤‡∏°‡∏µ</span>
                        <span class="wak-lang"><span class="word-to-find" data-word="‡∏°‡∏•‡∏≤‡∏¢">‡∏°‡∏•‡∏≤‡∏¢</span>‡∏û‡∏£‡∏∞</span>
                        <span class="kam-sroi">‡∏ä‡∏ô‡∏°‡πå‡πÄ‡∏Æ‡∏¢</span>
                    </div>

                    <!-- ‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà ‡πî: ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤ 5 ‡∏Ñ‡∏≥ + ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏á 4 ‡∏Ñ‡∏≥ -->
                    <div class="bart">
                        <span class="wak-na">‡∏Ç‡∏±‡∏ö<span class="word-to-find" data-word="‡∏Ñ‡πÄ‡∏ä‡∏ô‡∏ó‡∏£">‡∏Ñ‡πÄ‡∏ä‡∏ô‡∏ó‡∏£</span>‡πÄ‡∏Ç‡πà‡∏ô‡∏Ñ‡πâ‡∏≥</span>
                        <span class="wak-lang">‡∏™‡∏∞‡∏≠‡∏∂‡∏Å‡∏™‡∏π‡πâ<span class="word-to-find" data-word="‡∏î‡∏±‡∏™‡∏Å‡∏£">‡∏î‡∏±‡∏™‡∏Å‡∏£</span></span>
                    </div>

                    <!-- ‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà ‡πï: ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤ 5 ‡∏Ñ‡∏≥ + ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏á 2 ‡∏Ñ‡∏≥ -->
                    <div class="bart">
                        <span class="wak-na"> ‡πè ‡∏Ç‡∏∏‡∏ô‡∏°‡∏≠‡∏ç‡∏£‡πà‡∏≠‡∏ô<span class="word-to-find" data-word="‡∏á‡πâ‡∏≤‡∏ß">‡∏á‡πâ‡∏≤‡∏ß</span>‡∏ü‡∏≤‡∏î</span>
                        <span class="wak-lang">‡∏â‡∏≤‡∏î‡∏â‡∏∞</span>
                    </div>

                    <!-- ‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà ‡πñ: ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤ 5 ‡∏Ñ‡∏≥ + ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏á 2 ‡∏Ñ‡∏≥ -->
                    <div class="bart">
                        <span class="wak-na">‡∏Ç‡∏≤‡∏î<span class="word-to-find" data-word="‡πÅ‡∏•‡πà‡∏á">‡πÅ‡∏•‡πà‡∏á</span>‡∏ï‡∏£‡∏≤‡∏ö<span class="word-to-find" data-word="‡∏≠‡∏∏‡∏£‡∏∞">‡∏≠‡∏∏‡∏£‡∏∞</span></span>
                        <span class="wak-lang"><span class="word-to-find" data-word="‡∏´‡∏£‡∏∏‡∏ö">‡∏´‡∏£‡∏∏‡∏ö</span>‡∏î‡∏¥‡πâ‡∏ô</span>
                    </div>

                    <!-- ‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà ‡πó: ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤ 5 ‡∏Ñ‡∏≥ + ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏á 2 ‡∏Ñ‡∏≥ + ‡∏Ñ‡∏≥‡∏™‡∏£‡πâ‡∏≠‡∏¢ 2 ‡∏Ñ‡∏≥ -->
                    <div class="bart">
                        <span class="wak-na">‡πÇ‡∏≠‡∏£‡∏™‡∏£‡∏µ‡∏ö‡∏Å‡∏±‡∏ô‡∏û‡∏£‡∏∞</span>
                        <span class="wak-lang">‡∏®‡∏û‡∏™‡∏π‡πà</span>
                        <span class="kam-sroi">‡∏ô‡∏Ñ‡∏£‡πÅ‡∏Æ</span>
                    </div>

                    <!-- ‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà ‡πò: ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤ 5 ‡∏Ñ‡∏≥ + ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏á 4 ‡∏Ñ‡∏≥ -->
                    <div class="bart">
                        <span class="wak-na">‡∏™‡∏π‡∏ç‡∏ä‡∏µ‡∏û<span class="word-to-find" data-word="‡πÑ‡∏õ‡πà">‡πÑ‡∏õ‡πà</span>‡∏™‡∏π‡∏ç‡∏™‡∏¥‡πâ‡∏ô</span>
                        <span class="wak-lang"><span class="word-to-find" data-word="‡∏û‡∏à‡∏ô‡πå">‡∏û‡∏à‡∏ô‡πå</span>‡∏ú‡∏π‡πâ‡∏™‡∏£‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏ç</span>
                    </div>
                </div>`,
                hardWords: {
                    "‡∏ô‡∏á‡∏Ñ‡∏£‡∏≤‡∏ç": { meaning: "‡∏ô‡∏≤‡∏á‡∏á‡∏≤‡∏°, ‡∏™‡∏≤‡∏ß‡∏á‡∏≤‡∏°, ‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°, ‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á", points: 15 },
                    "‡∏°‡∏≤‡∏ô": { meaning: "‡∏´‡∏±‡∏ß‡πÉ‡∏à, ‡∏à‡∏¥‡∏ï‡πÉ‡∏à, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å, ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå", points: 15 },
                    "‡∏Å‡∏±‡∏ï‡πÄ‡∏ß‡∏ó‡∏µ": { meaning: "‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏∏‡∏ì, ‡∏£‡∏π‡πâ‡∏Ñ‡∏∏‡∏ì, ‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π, ‡∏™‡∏≥‡∏ô‡∏∂‡∏Å‡πÉ‡∏ô‡∏û‡∏£‡∏∞‡∏Ñ‡∏∏‡∏ì", points: 20 },
                    "‡∏°‡∏•‡∏≤‡∏¢": { meaning: "‡∏ï‡∏≤‡∏¢, ‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï, ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï, ‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï", points: 18 },
                    "‡∏Ñ‡πÄ‡∏ä‡∏ô‡∏ó‡∏£": { meaning: "‡∏ä‡πâ‡∏≤‡∏á, ‡∏ä‡πâ‡∏≤‡∏á‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å, ‡∏û‡∏≤‡∏´‡∏ô‡∏∞, ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏´‡∏ç‡πà", points: 20 },
                    "‡∏î‡∏±‡∏™‡∏Å‡∏£": { meaning: "‡∏Ç‡πâ‡∏≤‡∏®‡∏∂‡∏Å, ‡∏®‡∏±‡∏ï‡∏£‡∏π, ‡∏Ñ‡∏π‡πà‡∏≠‡∏£‡∏¥, ‡∏ú‡∏π‡πâ‡∏£‡πâ‡∏≤‡∏¢", points: 18 },
                    "‡∏á‡πâ‡∏≤‡∏ß": { meaning: "‡∏î‡∏≤‡∏ö‡∏î‡πâ‡∏≤‡∏°‡∏¢‡∏≤‡∏ß, ‡∏ó‡∏ß‡∏ô, ‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò, ‡∏´‡∏≠‡∏Å, ‡πÉ‡∏™", points: 15 },
                    "‡πÅ‡∏•‡πà‡∏á": { meaning: "‡∏ú‡πà‡∏≤, ‡πÅ‡∏¢‡∏Å, ‡∏ü‡∏±‡∏ô, ‡∏ï‡∏±‡∏î", points: 15 },
                    "‡∏≠‡∏∏‡∏£‡∏∞": { meaning: "‡∏≠‡∏Å, ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å, ‡∏ó‡∏£‡∏ß‡∏á‡∏≠‡∏Å, ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢", points: 12 },
                    "‡∏´‡∏£‡∏∏‡∏ö": { meaning: "‡∏£‡πà‡∏ß‡∏á, ‡∏ï‡∏Å, ‡∏•‡πâ‡∏°, ‡∏´‡∏•‡πà‡∏ô", points: 15 },
                    "‡πÑ‡∏õ‡πà": { meaning: "‡πÑ‡∏°‡πà, ‡∏°‡∏¥, ‡∏´‡∏≤...‡πÑ‡∏°‡πà, ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò", points: 10 },
                    "‡∏û‡∏à‡∏ô‡πå": { meaning: "‡∏û‡∏π‡∏î, ‡∏Å‡∏•‡πà‡∏≤‡∏ß, ‡∏Ñ‡∏≥‡∏û‡∏π‡∏î, ‡∏ß‡∏≤‡∏à‡∏≤", points: 15 }
                },
                correctInterpretation: "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢‡πÄ‡∏Å‡∏£‡∏á‡∏ß‡πà‡∏≤‡∏û‡∏£‡∏∞‡∏™‡∏ß‡∏≤‡∏°‡∏µ‡∏à‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå‡∏à‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏Ç‡∏±‡∏ö‡∏ä‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤‡∏á‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏õ‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏õ‡∏£‡πÅ‡∏ó‡∏ô ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏õ‡∏£‡πÄ‡∏≠‡∏≤‡∏á‡πâ‡∏≤‡∏ß‡∏ü‡∏±‡∏ô‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢ ‡∏ú‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏≠‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏ä‡πâ‡∏≤‡∏á ‡∏™‡∏≠‡∏á‡∏û‡∏£‡∏∞‡πÇ‡∏≠‡∏£‡∏™‡∏Ñ‡∏∑‡∏≠ ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡πÄ‡∏°‡∏®‡∏ß‡∏£ ‡πÅ‡∏•‡∏∞‡∏°‡∏´‡∏¥‡∏ô‡∏ó‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ô‡∏û‡∏£‡∏∞‡∏®‡∏û‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∂‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ï‡πà‡∏Ñ‡∏≥‡∏™‡∏£‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏ç‡πÄ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠",
                correctInterpretationKeywords: [
                    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢", "‡∏Å‡∏£‡∏∞‡∏©‡∏±‡∏ï‡∏£‡∏µ‡∏¢‡πå", "‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏∏‡∏ì", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏≤‡∏°‡∏µ", "‡∏ï‡∏≤‡∏¢", 
                    "‡∏ä‡πâ‡∏≤‡∏á", "‡∏Ç‡πâ‡∏≤‡∏®‡∏∂‡∏Å", "‡∏Ç‡∏∏‡∏ô‡∏°‡∏≠‡∏ç", "‡∏á‡πâ‡∏≤‡∏ß", "‡∏ú‡πà‡∏≤", "‡∏≠‡∏Å", "‡∏£‡πà‡∏ß‡∏á", "‡πÇ‡∏≠‡∏£‡∏™", "‡∏û‡∏£‡∏∞‡∏®‡∏û", "‡∏ô‡∏Ñ‡∏£", "‡∏Ñ‡∏≥‡∏û‡∏π‡∏î", "‡∏™‡∏£‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏ç"
                ],
                officialImageURL: "https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_y6eb9wy6eb9wy6eb.png",
                officialImageDescription: "‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢‡∏ö‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ä‡πâ‡∏≤‡∏á ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏≤‡∏°‡∏µ",
                comprehensionQuestions: [
                    {
                        question: "‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢‡∏ó‡∏£‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ï‡πà‡∏≠‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏≤‡∏°‡∏µ",
                        options: ["‡πÄ‡∏Å‡∏£‡∏á‡∏Å‡∏•‡∏±‡∏ß", "‡πÄ‡∏Å‡∏£‡∏á‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏´‡πà‡∏ß‡∏á‡πÉ‡∏¢", "‡πÇ‡∏Å‡∏£‡∏ò‡πÅ‡∏Ñ‡πâ‡∏ô", "‡πÄ‡∏â‡∏¢‡πÄ‡∏°‡∏¢"],
                        correct: 1
                    },
                    {
                        question: "‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏î‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢‡∏à‡∏∂‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏Ç‡∏±‡∏ö‡∏ä‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏£‡∏ö",
                        options: ["‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç", "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏≤‡∏°‡∏µ", "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏Å‡∏±‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π", "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô"],
                        correct: 1
                    },
                    {
                        question: "‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '‡∏Ç‡∏≤‡∏î‡πÅ‡∏•‡πà‡∏á‡∏ï‡∏£‡∏≤‡∏ö‡∏≠‡∏∏‡∏£‡∏∞ ‡∏´‡∏£‡∏∏‡∏ö‡∏î‡∏¥‡πâ‡∏ô' ‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£",
                        options: ["‡∏ñ‡∏π‡∏Å‡∏ü‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡∏ô", "‡∏ñ‡∏π‡∏Å‡∏ú‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏°‡∏•‡∏á", "‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏á‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≠‡∏á", "‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á"],
                        correct: 1
                    },
                    {
                        question: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡∏•‡∏á‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£",
                        options: ["‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤‡πÇ‡∏®‡∏Å", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏•‡∏∞", "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Å‡∏£‡∏ò‡πÅ‡∏Ñ‡πâ‡∏ô", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏î‡∏Å‡∏•‡∏±‡∏ß"],
                        correct: 1
                    },
                    {
                        question: "‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏•‡∏á '‡∏™‡∏π‡∏ç‡∏ä‡∏µ‡∏û‡πÑ‡∏õ‡πà‡∏™‡∏π‡∏ç‡∏™‡∏¥‡πâ‡∏ô ‡∏û‡∏à‡∏ô‡πå‡∏ú‡∏π‡πâ‡∏™‡∏£‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏ç' ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£",
                        options: ["‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏à‡∏ö‡∏•‡∏á‡πÅ‡∏ï‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà", "‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏´‡∏°‡∏î", "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏à‡∏≥‡πÑ‡∏î‡πâ", "‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥"],
                        correct: 0
                    }
                ]
            }
        };

        // Database Functions
        async function saveUserData(userData) {
            try {
                if (db && gameState.userId) {
                    // Save to Firebase User collection
                    await db.collection('User').doc(gameState.userId).set(userData, { merge: true });
                    console.log('User data saved to Firebase User collection');
                } else {
                    // Fallback to localStorage
                    localStorage.setItem(`student_${gameState.userId}`, JSON.stringify(userData));
                    console.log('User data saved to localStorage');
                }
                return true;
            } catch (error) {
                console.error('Error saving user data:', error);
                // Fallback to localStorage
                localStorage.setItem(`student_${gameState.userId}`, JSON.stringify(userData));
                return false;
            }
        }

        async function loadUserData(userId) {
            try {
                if (db) {
                    // Try Firebase User collection first
                    const doc = await db.collection('User').doc(userId).get();
                    if (doc.exists) {
                        console.log('User data loaded from Firebase User collection');
                        return doc.data();
                    }
                }
                
                // Fallback to localStorage
                const localData = localStorage.getItem(`student_${userId}`);
                if (localData) {
                    console.log('User data loaded from localStorage');
                    return JSON.parse(localData);
                }
                
                return null;
            } catch (error) {
                console.error('Error loading user data:', error);
                // Fallback to localStorage
                const localData = localStorage.getItem(`student_${userId}`);
                return localData ? JSON.parse(localData) : null;
            }
        }

        async function saveGameSession(gameData) {
            try {
                const sessionData = {
                    ...gameData,
                    userId: gameState.userId,
                    userName: gameState.currentUser?.name || 'Unknown',
                    userEmail: gameState.currentUser?.email || '',
                    studentId: gameState.currentUser?.studentId || '',
                    timestamp: new Date().toISOString(),
                    completed: gameState.currentStep === 6,
                    lastUpdated: new Date().toISOString()
                };

                if (db && gameState.gameId) {
                    // Save to Firebase (keeping gameSessions for temporary data)
                    await db.collection('gameSessions').doc(gameState.gameId).set(sessionData, { merge: true });
                    console.log('Game session saved to Firebase:', gameState.gameId);
                } else {
                    // Fallback to localStorage
                    localStorage.setItem(`gameSession_${gameState.gameId}`, JSON.stringify(sessionData));
                    console.log('Game session saved to localStorage');
                }
                return true;
            } catch (error) {
                console.error('Error saving game session:', error);
                localStorage.setItem(`gameSession_${gameState.gameId}`, JSON.stringify(sessionData));
                return false;
            }
        }

        // Save all user answers to Firebase UserAnswer collection
        async function saveAllUserAnswers() {
            try {
                if (!gameState.userId || !db) {
                    console.log('No userId or db connection, skipping UserAnswer save');
                    return false;
                }

                const answersData = {
                    userId: gameState.userId,
                    gameId: gameState.gameId,
                    userName: gameState.currentUser?.name || 'Unknown',
                    studentId: gameState.currentUser?.studentId || '',
                    userEmail: gameState.currentUser?.email || '',
                    grade: gameState.currentUser?.grade || '',
                    room: gameState.currentUser?.room || '',
                    number: gameState.currentUser?.number || '',
                    
                    // Vocabulary answers (correct ones)
                    vocabularyAnswers: Object.keys(gameState.translatedWords).map(word => ({
                        word: word,
                        userAnswer: gameState.translatedWords[word].translation,
                        correctAnswer: MISSION_DATA.MISSION_01.hardWords[word].meaning,
                        reference: gameState.translatedWords[word].reference,
                        points: gameState.translatedWords[word].points,
                        timestamp: gameState.translatedWords[word].timestamp,
                        isCorrect: true
                    })),
                    
                    // Incorrect vocabulary attempts
                    incorrectAttempts: Object.keys(gameState.incorrectWords).map(word => ({
                        word: word,
                        userAnswer: gameState.incorrectWords[word].translation,
                        correctAnswer: MISSION_DATA.MISSION_01.hardWords[word].meaning,
                        reference: gameState.incorrectWords[word].reference,
                        timestamp: gameState.incorrectWords[word].timestamp,
                        isCorrect: false
                    })),
                    
                    // Creative writing answers
                    imaginationText: gameState.imaginationText || '',
                    interpretationText: gameState.interpretationText || '',
                    
                    // Comprehension quiz answers
                    comprehensionAnswers: (gameState.comprehensionAnswers || []).map((answer, index) => ({
                        questionIndex: index,
                        question: MISSION_DATA.MISSION_01.comprehensionQuestions[index]?.question || '',
                        userAnswer: answer >= 0 ? MISSION_DATA.MISSION_01.comprehensionQuestions[index]?.options[answer] || '' : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö',
                        correctAnswer: MISSION_DATA.MISSION_01.comprehensionQuestions[index]?.options[MISSION_DATA.MISSION_01.comprehensionQuestions[index]?.correct] || '',
                        isCorrect: answer === MISSION_DATA.MISSION_01.comprehensionQuestions[index]?.correct,
                        timestamp: new Date().toISOString()
                    })),
                    comprehensionScore: gameState.comprehensionScore || 0,
                    
                    // Matching game data
                    matchingScore: gameState.matchingScore || 0,
                    matchedPairs: gameState.matchedPairs || 0,
                    
                    // Game metadata
                    currentStep: gameState.currentStep,
                    startTime: gameState.startTime,
                    completedAt: new Date().toISOString(),
                    totalScore: calculateCurrentScore(),
                    
                    // Mission info
                    missionId: 'MISSION_01',
                    missionTitle: '‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û - ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏û‡∏á‡∏®‡∏≤‡∏ß‡∏î‡∏≤‡∏£'
                };

                // Save to Firebase UserAnswer collection with unique document ID
                const answersDocId = `${gameState.userId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                await db.collection('UserAnswer').doc(answersDocId).set(answersData);
                
                console.log('All user answers saved to Firebase UserAnswer collection:', answersDocId);
                return true;
                
            } catch (error) {
                console.error('Error saving user answers to UserAnswer collection:', error);
                return false;
            }
        }

        // Calculate current score
        function calculateCurrentScore() {
            let vocabularyScore = 0;
            Object.values(gameState.translatedWords).forEach(word => {
                vocabularyScore += word.points;
            });
            
            const comprehensionScore = gameState.comprehensionScore * 20;
            const timeElapsed = (Date.now() - gameState.startTime) / 1000 / 60;
            const timeBonus = Math.max(0, Math.floor(50 - timeElapsed * 2));
            
            return vocabularyScore + comprehensionScore + timeBonus;
        }

        async function loadGameSession(gameId) {
            try {
                if (db) {
                    const doc = await db.collection('gameSessions').doc(gameId).get();
                    if (doc.exists) {
                        return doc.data();
                    }
                }
                
                const localData = localStorage.getItem(`gameSession_${gameId}`);
                return localData ? JSON.parse(localData) : null;
            } catch (error) {
                console.error('Error loading game session:', error);
                const localData = localStorage.getItem(`gameSession_${gameId}`);
                return localData ? JSON.parse(localData) : null;
            }
        }

        // Authentication Functions
        async function signInWithGoogle() {
            try {
                if (auth) {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const result = await auth.signInWithPopup(provider);
                    const user = result.user;
                    
                    gameState.userId = user.uid;
                    gameState.currentUser = {
                        name: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        isGoogle: true
                    };
                    
                    // Load or create user profile
                    let userData = await loadUserData(user.uid);
                    if (!userData) {
                        userData = {
                            name: user.displayName,
                            email: user.email,
                            photoURL: user.photoURL,
                            registeredAt: new Date().toISOString(),
                            exp: 0,
                            rank: '‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà',
                            level: 1,
                            totalGamesPlayed: 0,
                            bestScore: 0,
                            isGoogle: true
                        };
                        await saveUserData(userData);
                    }
                    
                    // Update player profile
                    playerProfile.exp = userData.exp || 0;
                    playerProfile.rank = userData.rank || '‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà';
                    playerProfile.level = userData.level || 1;
                    playerProfile.totalGamesPlayed = userData.totalGamesPlayed || 0;
                    playerProfile.bestScore = userData.bestScore || 0;
                    
                    updateLoginUI({
                        displayName: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        isGoogle: true,
                        userData: userData
                    });
                    
                    updateUserNameDisplay();
                    showNotification(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${user.displayName}!`, 'success');
                } else {
                    showNotification('‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô Google ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ô‡∏µ‡πâ', 'error');
                }
            } catch (error) {
                console.error('Google sign-in error:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
            }
        }
        
        async function signOutUser() {
            try {
                // Save current game state before signing out
                if (gameState.gameId && gameState.userId) {
                    await saveCurrentGameState();
                    await saveAllUserAnswers();
                }
                
                // Clear user data
                gameState.userId = null;
                gameState.currentUser = null;
                localStorage.removeItem('lastStudentId');
                
                // Reset game state
                gameState.currentStep = 1;
                gameState.translatedWords = {};
                gameState.incorrectWords = {};
                gameState.imaginationText = '';
                gameState.interpretationText = '';
                gameState.comprehensionScore = 0;
                gameState.startTime = Date.now();
                gameState.selectedWord = null;
                gameState.stepHistory = [];
                gameState.comprehensionAnswers = [];
                gameState.gameId = null;
                
                // Update UI
                updateLoginUI(null);
                showNotification('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                
            } catch (error) {
                console.error('Error signing out:', error);
                // Still proceed with sign out even if save fails
                gameState.userId = null;
                gameState.currentUser = null;
                localStorage.removeItem('lastStudentId');
                updateLoginUI(null);
                showNotification('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            }
        }
        
        // Student Management Functions
        function showStudentForm() {
            document.getElementById('loginButtons').classList.add('hidden');
            document.getElementById('studentForm').classList.remove('hidden');
        }
        
        function hideStudentForm() {
            document.getElementById('loginButtons').classList.remove('hidden');
            document.getElementById('studentForm').classList.add('hidden');
            clearStudentForm();
        }
        
        function showLoginForm() {
            document.getElementById('loginButtons').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }
        
        function hideLoginForm() {
            document.getElementById('loginButtons').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            clearLoginForm();
        }
        
        function clearStudentForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentId').value = '';
            document.getElementById('studentGrade').value = '';
            document.getElementById('studentRoom').value = '';
            document.getElementById('studentNumber').value = '';
            document.getElementById('studentPhone').value = '';
        }
        
        function clearLoginForm() {
            document.getElementById('loginStudentId').value = '';
            document.getElementById('loginPhone').value = '';
        }
        
        async function registerStudent() {
            const name = document.getElementById('studentName').value.trim();
            const studentId = document.getElementById('studentId').value.trim();
            const grade = document.getElementById('studentGrade').value;
            const room = document.getElementById('studentRoom').value.trim();
            const number = document.getElementById('studentNumber').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();
            
            // Validation
            if (!name || !studentId || !grade || !room || !number || !phone) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            if (phone.length < 10) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            const studentData = {
                name: name,
                studentId: studentId,
                grade: grade,
                room: room,
                number: number,
                phone: phone,
                registeredAt: new Date().toISOString(),
                exp: 0,
                rank: '‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà',
                level: 1,
                totalGamesPlayed: 0,
                bestScore: 0,
                isStudent: true
            };
            
            try {
                // Set current user
                gameState.userId = studentId;
                gameState.currentUser = studentData;
                
                // Save to database
                await saveUserData(studentData);
                
                // Save last student ID for auto-login
                localStorage.setItem('lastStudentId', studentId);
                
                // Update player profile
                playerProfile.exp = studentData.exp;
                playerProfile.rank = studentData.rank;
                playerProfile.level = studentData.level;
                playerProfile.totalGamesPlayed = studentData.totalGamesPlayed;
                playerProfile.bestScore = studentData.bestScore;
                
                // Update UI
                updateLoginUI({
                    displayName: name,
                    email: `${grade}/${room} ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${number}`,
                    photoURL: '',
                    isStudent: true,
                    studentData: studentData
                });
                
                updateUserNameDisplay();
                showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
                hideStudentForm();
                
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }
        
        async function loginStudent() {
            const studentId = document.getElementById('loginStudentId').value.trim();
            const phone = document.getElementById('loginPhone').value.trim();
            
            if (!studentId || !phone) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', 'error');
                return;
            }
            
            try {
                // Try to load from database first
                let studentData = await loadUserData(studentId);
                
                if (!studentData) {
                    showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
                    return;
                }
                
                // Verify phone number
                if (studentData.phone !== phone) {
                    showNotification('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    return;
                }
                
                // Set current user
                gameState.userId = studentId;
                gameState.currentUser = studentData;
                
                // Save last student ID for auto-login
                localStorage.setItem('lastStudentId', studentId);
                
                // Update player profile
                playerProfile.exp = studentData.exp || 0;
                playerProfile.rank = studentData.rank || '‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà';
                playerProfile.level = studentData.level || 1;
                playerProfile.totalGamesPlayed = studentData.totalGamesPlayed || 0;
                playerProfile.bestScore = studentData.bestScore || 0;
                
                // Update UI
                updateLoginUI({
                    displayName: studentData.name,
                    email: `${studentData.grade}/${studentData.room} ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${studentData.number}`,
                    photoURL: '',
                    isStudent: true,
                    studentData: studentData
                });
                
                showNotification(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${studentData.name}!`, 'success');
                hideLoginForm();
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
            }
        }
        
        function updateLoginUI(user) {
            const loginButtons = document.getElementById('loginButtons');
            const studentForm = document.getElementById('studentForm');
            const loginForm = document.getElementById('loginForm');
            const userInfo = document.getElementById('userInfo');
            const startGameBtn = document.getElementById('startGameBtn');
            const landingPage = document.getElementById('landingPage');
            
            if (user) {
                // Hide all forms
                if (loginButtons) loginButtons.classList.add('hidden');
                if (studentForm) studentForm.classList.add('hidden');
                if (loginForm) loginForm.classList.add('hidden');
                if (userInfo) userInfo.classList.remove('hidden');
                if (startGameBtn) startGameBtn.disabled = false;
                
                // Add class to make background more transparent when logged in
                if (landingPage) landingPage.classList.add('user-logged-in');
                
                // Update user info
                const userName = document.getElementById('userName');
                const userDetails = document.getElementById('userDetails');
                const userStats = document.getElementById('userStats');
                const userPhoto = document.getElementById('userPhoto');
                
                if (userName) userName.textContent = user.displayName;
                if (userDetails) userDetails.textContent = user.email;
                if (userStats) userStats.textContent = `EXP: ${playerProfile.exp} | ‡πÄ‡∏Å‡∏°: ${playerProfile.totalGamesPlayed}`;
                
                // Set student avatar
                if (userPhoto) {
                    userPhoto.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzYjgyZjYiLz4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI4IiB5PSI4Ij4KPHBhdGggZD0iTTEyIDEyQzE0LjIwOTEgMTIgMTYgMTAuMjA5MSAxNiA4QzE2IDUuNzkwODYgMTQuMjA5MSA0IDEyIDRDOS43OTA4NiA0IDggNS43OTA4NiA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMTRDOC4xMzQwMSAxNCA1IDE3LjEzNDEgNSAyMUg5SDE1SDE5QzE5IDE3LjEzNDEgMTUuODY2IDE0IDEyIDE0WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cjwvc3ZnPgo=';
                }
                
                gameState.userId = gameState.userId;
            } else {
                // Show login options
                if (loginButtons) loginButtons.classList.remove('hidden');
                if (studentForm) studentForm.classList.add('hidden');
                if (loginForm) loginForm.classList.add('hidden');
                if (userInfo) userInfo.classList.add('hidden');
                if (startGameBtn) startGameBtn.disabled = true;
                
                // Remove class to show background clearly when not logged in
                if (landingPage) landingPage.classList.remove('user-logged-in');
                
                gameState.userId = null;
                gameState.currentUser = null;
            }
        }
        
        // Check for existing student login on page load
        window.addEventListener('load', async () => {
            // Try to restore previous student session
            const lastStudentId = localStorage.getItem('lastStudentId');
            if (lastStudentId) {
                try {
                    // Try to load from database first
                    let userData = await loadUserData(lastStudentId);
                    
                    if (userData) {
                        gameState.userId = lastStudentId;
                        gameState.currentUser = userData;
                        
                        // Update player profile
                        playerProfile.exp = userData.exp || 0;
                        playerProfile.rank = userData.rank || '‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà';
                        playerProfile.level = userData.level || 1;
                        playerProfile.totalGamesPlayed = userData.totalGamesPlayed || 0;
                        playerProfile.bestScore = userData.bestScore || 0;
                        
                        // Update UI
                        if (userData.isGoogle) {
                            updateLoginUI({
                                displayName: userData.name,
                                email: userData.email,
                                photoURL: userData.photoURL,
                                isGoogle: true,
                                userData: userData
                            });
                        } else {
                            updateLoginUI({
                                displayName: userData.name,
                                email: `${userData.grade}/${userData.room} ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${userData.number}`,
                                photoURL: '',
                                isStudent: true,
                                studentData: userData
                            });
                        }
                        
                        console.log('User session restored successfully');
                    }
                } catch (error) {
                    console.log('Error restoring user session:', error);
                    localStorage.removeItem('lastStudentId');
                }
            }
        });

        // Navigation Functions
        async function goBack() {
            try {
                // Save current state before going back
                await saveCurrentGameState();
                await saveAllUserAnswers();
                
                if (gameState.stepHistory.length > 0) {
                    const previousStep = gameState.stepHistory.pop();
                    await loadStepData(previousStep);
                    await renderStep(previousStep);
                } else if (gameState.currentStep > 1) {
                    const newStep = gameState.currentStep - 1;
                    await loadStepData(newStep);
                    await renderStep(newStep);
                }
                
                showNotification('‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            } catch (error) {
                console.error('Error going back:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö', 'error');
            }
        }

        async function goToHome() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ')) {
                try {
                    // Save current game state with all user data
                    await saveCurrentGameState();
                    await saveAllUserAnswers();
                    
                    // Hide game UI and show landing page
                    showLandingPage();
                    
                    showNotification('‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'success');
                } catch (error) {
                    console.error('Error going to home:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        async function resetGame() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ')) {
                try {
                    // Clear saved game data first
                    if (gameState.gameId) {
                        await clearGameSession(gameState.gameId);
                    }
                    
                    // Reset game state completely
                    gameState.currentStep = 1;
                    gameState.translatedWords = {};
                    gameState.incorrectWords = {};
                    gameState.wordAttempts = {};
                    gameState.imaginationText = '';
                    gameState.interpretationText = '';
                    gameState.comprehensionScore = 0;
                    gameState.startTime = Date.now();
                    gameState.selectedWord = null;
                    gameState.stepHistory = [];
                    gameState.comprehensionAnswers = [];
                    gameState.gameId = generateGameId();
                    
                    // Hide game UI and show landing page
                    showLandingPage();
                    
                    showNotification('‡πÄ‡∏Å‡∏°‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà!', 'success');
                } catch (error) {
                    console.error('Error resetting game:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°', 'error');
                }
            }
        }

        function showLandingPage() {
            const landingPage = document.getElementById('landingPage');
            const header = document.getElementById('header');
            const mainContent = document.getElementById('mainContent');
            
            if (landingPage) landingPage.classList.remove('hidden');
            if (header) header.classList.add('hidden');
            if (mainContent) mainContent.classList.add('hidden');
            
            // Update background transparency based on login status
            if (landingPage) {
                if (gameState.userId) {
                    landingPage.classList.add('user-logged-in');
                } else {
                    landingPage.classList.remove('user-logged-in');
                }
            }
            
            // Make sure start button is enabled if user is logged in
            const startGameBtn = document.getElementById('startGameBtn');
            if (startGameBtn && gameState.userId) {
                startGameBtn.disabled = false;
            }
        }

        function generateGameId() {
            return `game_${gameState.userId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        async function saveCurrentGameState() {
            const currentGameData = {
                currentStep: gameState.currentStep,
                translatedWords: gameState.translatedWords,
                incorrectWords: gameState.incorrectWords,
                wordAttempts: gameState.wordAttempts,
                imaginationText: gameState.imaginationText,
                interpretationText: gameState.interpretationText,
                comprehensionScore: gameState.comprehensionScore,
                startTime: gameState.startTime,
                stepHistory: gameState.stepHistory,
                comprehensionAnswers: gameState.comprehensionAnswers || [],
                matchingScore: gameState.matchingScore || 0,
                matchedPairs: gameState.matchedPairs || 0
            };
            
            await saveGameSession(currentGameData);
        }

        async function loadStepData(step) {
            try {
                if (gameState.gameId) {
                    const savedData = await loadGameSession(gameState.gameId);
                    if (savedData) {
                        // Restore data without changing current step
                        gameState.translatedWords = savedData.translatedWords || {};
                        gameState.incorrectWords = savedData.incorrectWords || {};
                        gameState.wordAttempts = savedData.wordAttempts || {};
                        gameState.imaginationText = savedData.imaginationText || '';
                        gameState.interpretationText = savedData.interpretationText || '';
                        gameState.comprehensionScore = savedData.comprehensionScore || 0;
                        gameState.comprehensionAnswers = savedData.comprehensionAnswers || [];
                        gameState.startTime = savedData.startTime || Date.now();
                        gameState.matchingScore = savedData.matchingScore || 0;
                        gameState.matchedPairs = savedData.matchedPairs || 0;
                        
                        // Update UI to reflect loaded data
                        setTimeout(() => {
                            updateWordStatesFromData();
                            updateWordCounts();
                            
                            // Update matching game UI if on matching step
                            if (step === 2.5 && gameState.matchingScore !== undefined) {
                                const scoreElement = document.getElementById('matchingScore');
                                if (scoreElement) {
                                    scoreElement.textContent = gameState.matchingScore;
                                }
                            }
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Error loading step data:', error);
            }
        }

        // Update word states from loaded data
        function updateWordStatesFromData() {
            // Update correct words
            Object.keys(gameState.translatedWords).forEach(word => {
                const wordElement = document.querySelector(`[data-word="${word}"]`);
                if (wordElement) {
                    wordElement.className = 'word-correct';
                }
            });
            
            // Update incorrect words and show hint images if needed
            Object.keys(gameState.incorrectWords).forEach(word => {
                const wordElement = document.querySelector(`[data-word="${word}"]`);
                if (wordElement) {
                    wordElement.className = 'word-incorrect';
                    
                    // Show hint image if attempted 2+ times
                    const attempts = gameState.wordAttempts[word] || 0;
                    if (attempts >= 2 && !wordElement.parentElement.querySelector('.hint-image')) {
                        const hintImageContainer = document.createElement('div');
                        hintImageContainer.className = 'absolute z-10 hint-image';
                        hintImageContainer.style.cssText = `
                            top: -80px;
                            left: 50%;
                            transform: translateX(-50%);
                            pointer-events: none;
                        `;
                        hintImageContainer.innerHTML = `
                            <div class="relative">
                                <img src="${getWordImage(word)}" alt="‡πÉ‡∏ö‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${word}" 
                                     class="w-16 h-16 md:w-20 md:h-20 rounded-xl border-4 border-yellow-400 object-cover shadow-2xl animate-pulse bg-white p-1">
                                <div class="absolute -top-2 -right-2 w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center text-xs font-bold text-yellow-900">üí°</div>
                            </div>
                        `;
                        wordElement.parentElement.style.position = 'relative';
                        wordElement.parentElement.appendChild(hintImageContainer);
                    }
                }
            });
        }

        async function clearGameSession(gameId) {
            try {
                if (db) {
                    await db.collection('gameSessions').doc(gameId).delete();
                } else {
                    localStorage.removeItem(`gameSession_${gameId}`);
                }
            } catch (error) {
                console.error('Error clearing game session:', error);
                localStorage.removeItem(`gameSession_${gameId}`);
            }
        }

        // Start Game Function
        async function startGame() {
            // Check if user is logged in
            if (!gameState.userId || !gameState.currentUser) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°', 'error');
                return;
            }
            
            // Try to load the most recent game session for this user
            try {
                // Look for existing game sessions
                let savedGame = null;
                
                if (db) {
                    // Query Firebase for the most recent game session
                    const gamesQuery = await db.collection('gameSessions')
                        .where('userId', '==', gameState.userId)
                        .orderBy('lastUpdated', 'desc')
                        .limit(1)
                        .get();
                    
                    if (!gamesQuery.empty) {
                        const gameDoc = gamesQuery.docs[0];
                        savedGame = gameDoc.data();
                        gameState.gameId = gameDoc.id;
                        console.log('Found saved game in Firebase:', gameDoc.id);
                    }
                } else {
                    // Fallback: check localStorage for saved games
                    const keys = Object.keys(localStorage);
                    const gameKeys = keys.filter(key => key.startsWith('gameSession_') && key.includes(gameState.userId));
                    
                    if (gameKeys.length > 0) {
                        // Get the most recent game
                        const mostRecentKey = gameKeys.sort().pop();
                        savedGame = JSON.parse(localStorage.getItem(mostRecentKey));
                        gameState.gameId = mostRecentKey.replace('gameSession_', '');
                        console.log('Found saved game in localStorage:', mostRecentKey);
                    }
                }
                
                if (savedGame && savedGame.currentStep > 1) {
                    // Restore saved game state
                    gameState.currentStep = savedGame.currentStep;
                    gameState.translatedWords = savedGame.translatedWords || {};
                    gameState.incorrectWords = savedGame.incorrectWords || {};
                    gameState.wordAttempts = savedGame.wordAttempts || {};
                    gameState.imaginationText = savedGame.imaginationText || '';
                    gameState.interpretationText = savedGame.interpretationText || '';
                    gameState.comprehensionScore = savedGame.comprehensionScore || 0;
                    gameState.comprehensionAnswers = savedGame.comprehensionAnswers || [];
                    gameState.startTime = savedGame.startTime || Date.now();
                    gameState.stepHistory = savedGame.stepHistory || [];
                    gameState.matchingScore = savedGame.matchingScore || 0;
                    gameState.matchedPairs = savedGame.matchedPairs || 0;
                    
                    showNotification(`‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${savedGame.currentStep})`, 'success');
                } else {
                    // Start fresh game
                    gameState.gameId = generateGameId();
                    gameState.currentStep = 1;
                    gameState.startTime = Date.now();
                    showNotification('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà!', 'success');
                }
                
            } catch (error) {
                console.error('Error loading saved game:', error);
                // Start fresh if loading fails
                gameState.gameId = generateGameId();
                gameState.currentStep = 1;
                gameState.startTime = Date.now();
                showNotification('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà!', 'success');
            }
            
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('header').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            updatePlayerProfile();
            updateProgress();
            updateUserNameDisplay();
            await renderStep(gameState.currentStep);
        }

        // Update Progress
        function updateProgress() {
            const totalSteps = 6;
            const currentProgress = ((gameState.currentStep - 1) / (totalSteps - 1)) * 100;
            
            document.getElementById('mainProgressFill').style.width = currentProgress + '%';
            document.getElementById('progressText').textContent = Math.round(currentProgress) + '%';
        }

        // Calculate Level and EXP
        function calculateLevel(exp) {
            const level = Math.floor(exp / 100) + 1;
            const expInCurrentLevel = exp % 100;
            const expToNextLevel = 100 - expInCurrentLevel;
            
            return {
                level: level,
                expInCurrentLevel: expInCurrentLevel,
                expToNextLevel: expToNextLevel
            };
        }

        // Update Player Profile Display
        function updatePlayerProfile() {
            document.getElementById('playerExp').textContent = playerProfile.exp;
            document.getElementById('playerRank').textContent = playerProfile.rank;
            
            // Calculate level
            const levelInfo = calculateLevel(playerProfile.exp);
            playerProfile.level = levelInfo.level;
            playerProfile.expToNextLevel = levelInfo.expToNextLevel;
            
            // Update rank based on EXP and level
            if (playerProfile.level >= 10) playerProfile.rank = '‡∏ô‡∏±‡∏Å‡∏™‡∏∑‡∏ö‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô';
            else if (playerProfile.level >= 5) playerProfile.rank = '‡∏ô‡∏±‡∏Å‡∏™‡∏∑‡∏ö‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç';
            else if (playerProfile.level >= 2) playerProfile.rank = '‡∏ô‡∏±‡∏Å‡∏™‡∏∑‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î';
            else playerProfile.rank = '‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà';
            
            saveUserDataAsync();
        }

        // Save User Data (Async)
        async function saveUserDataAsync() {
            if (gameState.currentUser && gameState.userId) {
                const updatedUserData = {
                    ...gameState.currentUser,
                    exp: playerProfile.exp,
                    rank: playerProfile.rank,
                    level: playerProfile.level,
                    totalGamesPlayed: playerProfile.totalGamesPlayed,
                    bestScore: playerProfile.bestScore,
                    lastPlayed: new Date().toISOString()
                };
                
                await saveUserData(updatedUserData);
                gameState.currentUser = updatedUserData;
            }
        }

        // Render Step Content
        async function renderStep(step) {
            // Save current step to history (except when going back)
            if (step > gameState.currentStep) {
                gameState.stepHistory.push(gameState.currentStep);
            }
            
            gameState.currentStep = step;
            updateStepIndicators();
            updateProgress();
            updateBackButton();
            
            // Auto-save progress
            saveCurrentGameState();
            
            const mainContent = document.getElementById('mainContent');
            const mission = MISSION_DATA.MISSION_01;
            
            switch(step) {
                case 1:
                    mainContent.innerHTML = `
                        <div class="modern-card rounded-3xl p-6 md:p-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                    üìö ${mission.historicalBackground.title}
                                </h2>
                                <span class="badge-modern">‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 1</span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">üìö</span>
                                    <h4 class="text-lg font-bold text-amber-900">‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h4>
                                </div>
                                <p class="text-amber-800">‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÇ‡∏Ñ‡∏•‡∏á</p>
                            </div>
                            
                            <div class="mb-8">
                                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-6 mb-6">
                                    <div class="flex items-center gap-3 mb-4">
                                        <span class="text-3xl">üìñ</span>
                                        <h3 class="text-xl font-bold text-blue-900">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3>
                                    </div>
                                    <p class="text-blue-800 text-lg">‡∏≠‡πà‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÇ‡∏Ñ‡∏•‡∏á</p>
                                </div>
                                
                                ${mission.historicalBackground.content}
                            </div>
                            
                            <div class="text-center space-y-4">
                                <button id="proceedToPoem" class="modern-button px-8 py-4 text-xl rounded-2xl">
                                    ‚û°Ô∏è ‡πÑ‡∏õ‡∏î‡∏π‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û
                                </button>
                                
                                <!-- Quick Navigation -->
                                <div class="mt-6">
                                    <p class="text-gray-600 mb-4">‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô:</p>
                                    <div class="flex flex-wrap justify-center gap-3">
                                        <button onclick="goToStep(2)" class="modern-button px-4 py-2 text-sm rounded-xl bg-blue-500 hover:bg-blue-600">üìñ ‡πÇ‡∏Ñ‡∏•‡∏á</button>
                                        <button onclick="goToStep(3)" class="modern-button px-4 py-2 text-sm rounded-xl bg-purple-500 hover:bg-purple-600">‚úçÔ∏è ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</button>
                                        <button onclick="goToStep(4)" class="modern-button px-4 py-2 text-sm rounded-xl bg-green-500 hover:bg-green-600">üñºÔ∏è ‡∏†‡∏≤‡∏û</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('proceedToPoem').addEventListener('click', async () => {
                        await renderStep(2);
                    });
                    break;
                    
                case 2.5:
                    // Matching Game Step
                    mainContent.innerHTML = `
                        <div class="modern-card rounded-3xl p-4 md:p-10 mt-4 md:mt-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 gap-4">
                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                    üéØ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå
                                </h2>
                                <span class="badge-modern">‡πÄ‡∏Å‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©</span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-teal-50 to-cyan-50 border-2 border-teal-200 p-3 md:p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">üéØ</span>
                                    <h4 class="text-base md:text-lg font-bold text-teal-900">‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h4>
                                </div>
                                <p class="text-teal-800 text-sm md:text-base">‡πÄ‡∏Å‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥</p>
                            </div>
                            
                            <!-- Score Display -->
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-4 rounded-xl mb-6 text-center">
                                <h3 class="text-lg font-bold text-blue-900 mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                                <div class="text-3xl font-bold text-blue-600" id="matchingScore">0</div>
                                <div class="text-sm text-blue-700">‡∏à‡∏≤‡∏Å ${Object.keys(MISSION_DATA.MISSION_01.hardWords).length} ‡∏Ñ‡∏π‡πà</div>
                            </div>
                            
                            <!-- Matching Game -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <!-- Words Column -->
                                <div class="bg-gradient-to-br from-red-50 to-pink-50 border-2 border-red-200 p-4 rounded-xl">
                                    <h3 class="text-lg font-bold text-red-900 mb-4 text-center">üî§ ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</h3>
                                    <div id="wordsColumn" class="grid grid-cols-3 gap-3">
                                        ${Object.keys(MISSION_DATA.MISSION_01.hardWords).map((word, index) => `
                                            <div class="word-item bg-gradient-to-r from-red-400 to-red-500 text-white border-2 border-red-600 p-3 rounded-xl cursor-pointer hover:from-red-500 hover:to-red-600 transition-all duration-200 text-center font-bold shadow-lg" 
                                                 data-word="${word}" draggable="true">
                                                <div class="flex flex-col items-center justify-center gap-2">
                                                    <img src="${getWordImage(word)}" alt="${word}" class="w-16 h-16 md:w-20 md:h-20 rounded-lg border-2 border-white object-cover shadow-md">
                                                    <span class="text-sm">${word}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- Meanings Column -->
                                <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 p-4 rounded-xl">
                                    <h3 class="text-lg font-bold text-green-900 mb-4 text-center">üí≠ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢</h3>
                                    <div id="meaningsColumn" class="grid grid-cols-3 gap-3">
                                        ${Object.entries(MISSION_DATA.MISSION_01.hardWords).sort(() => Math.random() - 0.5).map(([word, data]) => `
                                            <div class="meaning-item bg-white border-2 border-green-300 p-3 rounded-xl min-h-[80px] flex items-center justify-center text-center text-green-800 border-dashed hover:bg-green-50 transition-all duration-200" 
                                                 data-word="${word}">
                                                <span class="font-semibold text-sm">${data.meaning.split(',')[0].trim()}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Instructions -->
                            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-200 p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">üìã</span>
                                    <h4 class="font-bold text-yellow-900">‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô</h4>
                                </div>
                                <p class="text-yellow-800">‡∏•‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡∏ö‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢</p>
                            </div>
                            
                            <div class="flex flex-col md:flex-row justify-center gap-4 mt-6 md:mt-10">
                                <button onclick="goBack()" class="modern-button px-6 md:px-8 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-gray-500 hover:bg-gray-600 w-full md:w-auto">
                                    ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                                </button>
                                <button id="resetMatching" class="modern-button px-6 md:px-8 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-orange-500 hover:bg-orange-600 w-full md:w-auto">
                                    üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                                </button>
                                <button id="finishMatching" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl w-full md:w-auto" disabled>
                                    ‚û°Ô∏è ‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                                </button>
                            </div>
                        </div>
                    `;
                    setupMatchingGame();
                    break;
                    
                case 2:
                    mainContent.innerHTML = `
                        <div class="modern-card rounded-3xl p-6 md:p-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                    üìú ‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û - ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏û‡∏á‡∏®‡∏≤‡∏ß‡∏î‡∏≤‡∏£
                                </h2>
                                <span class="badge-modern">‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 2</span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">üìñ</span>
                                    <h4 class="text-lg font-bold text-purple-900">‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h4>
                                </div>
                                <p class="text-purple-800">‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏¢‡∏≤‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ù‡∏∂‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡∏ö‡∏Ñ‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ</p>
                            </div>
                            
                            <div class="poem-container p-6 mb-6">
                                <div class="mb-4">
                                    <span class="badge-modern">‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û</span>
                                </div>
                                <div class="poem-text text-gray-800">
                                    ${mission.poem}
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-4 rounded-2xl mb-6">
                                <h3 class="text-lg font-bold text-blue-900 mb-3">üéØ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</h3>
                                <p class="text-blue-800 font-semibold">üëÜ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏•‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á ${Object.keys(mission.hardWords).length} ‡∏Ñ‡∏≥</p>
                            </div>
                            
                            <!-- Progress Cards -->
                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div class="modern-card rounded-xl p-4 text-center">
                                    <p class="text-gray-600 text-sm mb-2">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</p>
                                    <p class="text-xl font-bold text-blue-600">${Object.keys(mission.hardWords).length} ‡∏Ñ‡∏≥</p>
                                    <div class="progress-bar mt-3 bg-gray-200 h-3">
                                        <div id="wordProgress" class="progress-fill h-3" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="modern-card rounded-xl p-4 text-center">
                                    <p class="text-gray-600 text-sm mb-2">‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß</p>
                                    <p class="text-xl font-bold text-green-600"><span id="foundWords">0</span> ‡∏Ñ‡∏≥</p>
                                </div>
                                <div class="modern-card rounded-xl p-4 text-center">
                                    <p class="text-gray-600 text-sm mb-2">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î</p>
                                    <p class="text-xl font-bold text-red-600"><span id="incorrectWords">0</span> ‡∏Ñ‡∏≥</p>
                                </div>
                            </div>
                            
                            <!-- Dictionary Tools -->
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-6 mb-6">
                                <div class="text-center">
                                    <div class="text-5xl mb-4">üìö</div>
                                    <h3 class="text-xl font-bold text-blue-900 mb-4">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢</h3>
                                    <p class="text-blue-800 text-center mb-6">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</p>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <button onclick="openDictionaryNewTab()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center justify-center gap-3">
                                            <span class="text-2xl">üìñ</span>
                                            <span>‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô</span>
                                        </button>
                                        <button onclick="showKloangInfo()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center justify-center gap-3">
                                            <span class="text-2xl">üìã</span>
                                            <span>‡∏â‡∏±‡∏ô‡∏ó‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Next Button (Hidden initially) -->
                            <div class="text-center space-y-4">
                                <button id="nextToMatching" class="modern-button px-8 py-4 text-xl rounded-2xl hidden" onclick="showMatchingGame()">
                                    üéØ ‡πÑ‡∏õ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå
                                </button>
                                
                                <!-- Quick Navigation -->
                                <div class="mt-6">
                                    <p class="text-gray-600 mb-4">‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô:</p>
                                    <div class="flex flex-wrap justify-center gap-3">
                                        <button onclick="goToStep(1)" class="modern-button px-4 py-2 text-sm rounded-xl bg-amber-500 hover:bg-amber-600">üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                                        <button onclick="goToStep(3)" class="modern-button px-4 py-2 text-sm rounded-xl bg-purple-500 hover:bg-purple-600">‚úçÔ∏è ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</button>
                                        <button onclick="goToStep(4)" class="modern-button px-4 py-2 text-sm rounded-xl bg-green-500 hover:bg-green-600">üñºÔ∏è ‡∏†‡∏≤‡∏û</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    attachWordClickHandlers();
                    // Load saved data and update UI
                    setTimeout(() => {
                        updateWordStatesFromData();
                        updateWordCounts();
                        checkAllWordsFound();
                    }, 100);
                    break;
                    
                case 3:
                    mainContent.innerHTML = `
                        <!-- Poem Display -->
                        <div class="modern-card rounded-3xl p-4 md:p-6 mb-6">
                            <div class="poem-container p-4 md:p-6">
                                <div class="mb-4">
                                    <span class="badge-modern">‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û - ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</span>
                                </div>
                                <div class="poem-text text-gray-800 max-w-4xl mx-auto text-base md:text-lg">
                                    ${mission.poem}
                                </div>
                            </div>
                        </div>
                        
                        <div class="modern-card rounded-3xl p-4 md:p-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                    üìù ‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£
                                </h2>
                                <span class="badge-modern">‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 3</span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 border-2 border-indigo-200 p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">‚úçÔ∏è</span>
                                    <h4 class="text-lg font-bold text-indigo-900">‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h4>
                                </div>
                                <p class="text-indigo-800">‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</p>
                            </div>
                            
                            <!-- Interpretation Section -->
                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 p-6 rounded-2xl mb-6">
                                <h3 class="text-xl font-bold text-green-900 mb-4">üìù ‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°</h3>
                                <p class="text-green-800 mb-4">‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏Å‡πâ‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á</p>
                                <textarea id="interpretationInput" class="w-full h-48 modern-input p-4 text-base resize-none" placeholder="‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏Å‡πâ‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á...&#10;&#10;‡πÄ‡∏ä‡πà‡∏ô: ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢‡∏ó‡∏£‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏á‡∏î‡∏á‡∏≤‡∏° ‡∏ó‡∏£‡∏á‡∏°‡∏µ‡∏à‡∏¥‡∏ï‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π‡∏ï‡πà‡∏≠‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏≤‡∏°‡∏µ..."></textarea>
                            </div>
                            
                            <!-- Imagination Section -->
                            <div class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 p-6 rounded-2xl mb-6">
                                <h3 class="text-xl font-bold text-purple-900 mb-4">üé® ‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏û</h3>
                                <p class="text-purple-800 mb-4">‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏•‡∏á‡∏ô‡∏µ‡πâ</p>
                                <textarea id="imaginationInput" class="w-full h-40 modern-input p-4 text-base resize-none" placeholder="üñºÔ∏è ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î... ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ô‡πÉ‡∏à&#10;&#10;‡πÄ‡∏ä‡πà‡∏ô: ‡∏â‡∏±‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢‡∏ó‡∏£‡∏á‡∏Ç‡∏µ‡πà‡∏ä‡πâ‡∏≤‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ‡πÉ‡∏ô‡∏ó‡πà‡∏≤‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏£‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏±‡∏ô..."></textarea>
                            </div>
                            
                            <div class="text-center space-y-4">
                                <div class="flex flex-col md:flex-row justify-center gap-4">
                                    <button onclick="goBack()" class="modern-button px-6 py-3 text-lg rounded-2xl bg-gray-500 hover:bg-gray-600 w-full md:w-auto">
                                        ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                                    </button>
                                    <button id="nextStep3" class="modern-button px-8 py-3 text-lg disabled:opacity-50 disabled:cursor-not-allowed rounded-2xl w-full md:w-auto" disabled>
                                        ‚û°Ô∏è ‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                                    </button>
                                </div>
                                
                                <!-- Quick Navigation -->
                                <div class="mt-6">
                                    <p class="text-gray-600 mb-4">‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô:</p>
                                    <div class="flex flex-wrap justify-center gap-3">
                                        <button onclick="goToStep(1)" class="modern-button px-4 py-2 text-sm rounded-xl bg-amber-500 hover:bg-amber-600">üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                                        <button onclick="goToStep(2)" class="modern-button px-4 py-2 text-sm rounded-xl bg-blue-500 hover:bg-blue-600">üìñ ‡πÇ‡∏Ñ‡∏•‡∏á</button>
                                        <button onclick="goToStep(4)" class="modern-button px-4 py-2 text-sm rounded-xl bg-green-500 hover:bg-green-600">üñºÔ∏è ‡∏†‡∏≤‡∏û</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    setupStep3Handlers();
                    break;
                    
                case 4:
                    mainContent.innerHTML = `
                        <div class="modern-card rounded-3xl p-6 md:p-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                    üñºÔ∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á
                                </h2>
                                <span class="badge-modern">‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 4</span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">üñºÔ∏è</span>
                                    <h4 class="text-lg font-bold text-orange-900">‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h4>
                                </div>
                                <p class="text-orange-800">‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</p>
                            </div>
                            
                            <!-- Historical Image -->
                            <div class="text-center mb-8">
                                <h3 class="text-xl font-bold text-blue-900 mb-6">‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</h3>
                                <div class="relative max-w-4xl mx-auto">
                                    <div class="relative cursor-pointer" id="imageContainer">
                                        <img id="historicalImage" src="${mission.officialImageURL}" alt="‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢" class="w-full aspect-video object-cover rounded-2xl border-2 border-gray-300 shadow-xl blur-lg transition-all duration-1000" onerror="this.src=''; this.alt='‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ'; this.style.display='none';">
                                        <div id="imageOverlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-2xl transition-opacity duration-1000">
                                            <div class="text-white text-center">
                                                <div class="text-4xl mb-2 animate-bounce">üëÜ</div>
                                                <p class="text-lg font-bold">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏π‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏†‡∏≤‡∏û</p>
                                                <p class="text-sm mt-2 opacity-75">‡∏•‡∏≤‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏¥‡πâ‡∏ß‡∏ö‡∏ô‡∏†‡∏≤‡∏û</p>
                                            </div>
                                        </div>
                                        <canvas id="revealCanvas" class="absolute inset-0 w-full h-full rounded-2xl pointer-events-none opacity-0"></canvas>
                                    </div>
                                </div>
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 p-6 rounded-2xl mt-6 max-w-4xl mx-auto">
                                    <p class="text-blue-800 text-lg italic">${mission.officialImageDescription}</p>
                                </div>
                            </div>
                            
                            <!-- Comparison Button -->
                            <div class="text-center mb-8">
                                <button id="showComparison" class="modern-button px-8 py-4 text-xl rounded-2xl bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600">
                                    üí° ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πá‡∏Ñ‡∏∑‡∏≠...
                                </button>
                            </div>
                            
                            <!-- Comparison Section (Hidden initially) -->
                            <div id="comparisonSection" class="hidden mb-8">
                                <h3 class="text-xl font-bold text-purple-900 mb-6">‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏†‡∏≤‡∏û‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á</h3>
                                
                                <div class="space-y-6">
                                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 p-6 rounded-2xl">
                                        <h4 class="font-bold text-purple-800 mb-4 text-lg">üé® ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏ß‡πâ:</h4>
                                        <p class="text-purple-700 text-lg leading-relaxed">${gameState.imaginationText}</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 p-6 rounded-2xl">
                                        <h4 class="font-bold text-green-800 mb-4 text-lg">üìù ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ:</h4>
                                        <p class="text-green-700 text-lg leading-relaxed">${gameState.interpretationText}</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 p-6 rounded-2xl">
                                        <h4 class="font-bold text-blue-800 mb-4 text-lg">üìö ‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:</h4>
                                        <p class="text-blue-700 text-lg leading-relaxed">${mission.correctInterpretation}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center space-y-4">
                                <div class="flex flex-col md:flex-row justify-center gap-4">
                                    <button onclick="goBack()" class="modern-button px-6 py-3 text-lg rounded-2xl bg-gray-500 hover:bg-gray-600 w-full md:w-auto">
                                        ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                                    </button>
                                    <button id="nextStep4" class="modern-button px-8 py-3 text-lg rounded-2xl w-full md:w-auto">
                                        ‚û°Ô∏è ‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô
                                    </button>
                                </div>
                                
                                <!-- Quick Navigation -->
                                <div class="mt-6">
                                    <p class="text-gray-600 mb-4">‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô:</p>
                                    <div class="flex flex-wrap justify-center gap-3">
                                        <button onclick="goToStep(1)" class="modern-button px-4 py-2 text-sm rounded-xl bg-amber-500 hover:bg-amber-600">üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                                        <button onclick="goToStep(2)" class="modern-button px-4 py-2 text-sm rounded-xl bg-blue-500 hover:bg-blue-600">üìñ ‡πÇ‡∏Ñ‡∏•‡∏á</button>
                                        <button onclick="goToStep(3)" class="modern-button px-4 py-2 text-sm rounded-xl bg-purple-500 hover:bg-purple-600">‚úçÔ∏è ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    setupStep4Handlers();
                    // Setup image reveal effect
                    setTimeout(setupImageReveal, 100);
                    break;
                    
                case 5:
                    mainContent.innerHTML = `
                        <div class="modern-card rounded-3xl p-4 md:p-10 mt-4 md:mt-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 gap-4">
                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                    üìù ‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ
                                </h2>
                                <span class="badge-modern">‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 5</span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 p-3 md:p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">üìù</span>
                                    <h4 class="text-base md:text-lg font-bold text-indigo-900">‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h4>
                                </div>
                                <p class="text-indigo-800 text-sm md:text-base">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û</p>
                            </div>
                            
                            <!-- Score Display -->
                            <div class="bg-gradient-to-r from-blue-50 to-green-50 border-2 border-blue-200 p-4 rounded-xl mb-6 text-center">
                                <h3 class="text-lg font-bold text-blue-900 mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                                <div class="text-3xl font-bold text-blue-600" id="quizScore">0</div>
                                <div class="text-sm text-blue-700">‡∏à‡∏≤‡∏Å ${mission.comprehensionQuestions.length} ‡∏Ç‡πâ‡∏≠</div>
                            </div>
                            
                            <!-- Quiz Questions -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                ${mission.comprehensionQuestions.map((q, index) => `
                                    <div class="bg-gradient-to-br from-white to-gray-50 border-2 border-gray-200 p-4 rounded-xl">
                                        <h4 class="font-bold text-gray-900 mb-3">‡∏Ç‡πâ‡∏≠ ${index + 1}. ${q.question}</h4>
                                        <div class="space-y-2">
                                            ${q.options.map((option, optIndex) => `
                                                <label class="flex items-center p-2 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors duration-200">
                                                    <input type="radio" name="question_${index}" value="${optIndex}" class="mr-3 text-blue-600">
                                                    <span class="text-gray-700">${option}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                        <div id="result_${index}" class="mt-3 hidden"></div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="flex flex-col md:flex-row justify-center gap-4 mt-6 md:mt-10">
                                <button onclick="goBack()" class="modern-button px-6 md:px-8 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-gray-500 hover:bg-gray-600 w-full md:w-auto">
                                    ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                                </button>
                                <button id="checkAnswers" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl w-full md:w-auto" onclick="checkQuizAnswers()">
                                    ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                                </button>
                                <button id="retryQuiz" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl w-full md:w-auto bg-orange-500 hover:bg-orange-600 hidden" onclick="retryQuiz()">
                                    üîÑ ‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà
                                </button>
                                <button id="finishQuiz" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl w-full md:w-auto hidden" onclick="finishQuiz()">
                                    ‚û°Ô∏è ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                                </button>
                            </div>
                        </div>
                    `;
                    setupQuiz();
                    break;
                    
                case 6:
                    const finalScore = await calculateFinalScore();
                    updatePlayerProfile();
                    mainContent.innerHTML = `
                        <div class="modern-card rounded-3xl p-4 md:p-10 mt-4 md:mt-8">
                            <div class="text-center mb-6 md:mb-10">
                                <div class="text-6xl md:text-8xl mb-4 md:mb-6">üéâ</div>
                                <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</h2>
                                <p class="text-gray-600 text-lg md:text-xl">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ‡πÑ‡∏ó‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-10">
                                <div class="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200 p-4 md:p-8 rounded-2xl">
                                    <h3 class="text-xl md:text-2xl font-bold text-blue-900 mb-4 md:mb-6">üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</h3>
                                    <div class="text-4xl md:text-5xl font-bold text-blue-600 mb-4 md:mb-6">${finalScore.total} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                    <div class="space-y-2 md:space-y-3">
                                        <div class="flex justify-between text-base md:text-lg">
                                            <span>‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå:</span>
                                            <span class="text-green-600 font-bold">+${finalScore.vocabulary}</span>
                                        </div>
                                        <div class="flex justify-between text-base md:text-lg">
                                            <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à:</span>
                                            <span class="text-green-600 font-bold">+${finalScore.comprehension}</span>
                                        </div>
                                        <div class="flex justify-between text-base md:text-lg">
                                            <span>‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÄ‡∏ß‡∏•‡∏≤:</span>
                                            <span class="text-green-600 font-bold">+${finalScore.timeBonus}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-br from-green-50 to-yellow-50 border-2 border-green-200 p-4 md:p-8 rounded-2xl">
                                    <h3 class="text-xl md:text-2xl font-bold text-green-900 mb-4 md:mb-6">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h3>
                                    <div class="space-y-3 md:space-y-4">
                                        <div class="flex justify-between items-center text-base md:text-lg">
                                            <span>EXP ‡∏£‡∏ß‡∏°:</span>
                                            <span class="text-2xl md:text-3xl font-bold text-yellow-600">${playerProfile.exp}</span>
                                        </div>
                                        <div class="flex justify-between items-center text-base md:text-lg">
                                            <span>‡πÄ‡∏•‡πÄ‡∏ß‡∏•:</span>
                                            <span class="text-xl md:text-2xl font-bold text-blue-600">Lv.${playerProfile.level}</span>
                                        </div>
                                        <div class="flex justify-between items-center text-base md:text-lg">
                                            <span>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö:</span>
                                            <span class="badge-modern">${playerProfile.rank}</span>
                                        </div>
                                        <div class="flex justify-between text-base md:text-lg">
                                            <span>‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô:</span>
                                            <span class="text-gray-600 font-semibold">${playerProfile.totalGamesPlayed}</span>
                                        </div>
                                        <div class="flex justify-between text-base md:text-lg">
                                            <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:</span>
                                            <span class="text-purple-600 font-semibold">${playerProfile.bestScore}</span>
                                        </div>
                                        <div class="mt-4">
                                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                                <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
                                                <span>${100 - playerProfile.expToNextLevel}/100 EXP</span>
                                            </div>
                                            <div class="progress-bar bg-gray-200">
                                                <div class="progress-fill" style="width: ${((100 - playerProfile.expToNextLevel) / 100) * 100}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-6 md:mt-10 space-y-4">
                                <button onclick="showCertificate()" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 w-full md:w-auto">
                                    üèÜ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£
                                </button>
                            </div>
                            
                            <!-- Navigation Back to Sections -->
                            <div class="mt-8 md:mt-12">
                                <h3 class="text-xl md:text-2xl font-bold text-gray-900 mb-6 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <button onclick="goToStep(1)" class="modern-button px-4 py-3 text-sm md:text-base rounded-xl bg-amber-500 hover:bg-amber-600 flex flex-col items-center gap-2">
                                        <span class="text-2xl">üìö</span>
                                        <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</span>
                                        <span class="text-xs opacity-75">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: -</span>
                                    </button>
                                    <button onclick="goToStep(2)" class="modern-button px-4 py-3 text-sm md:text-base rounded-xl bg-blue-500 hover:bg-blue-600 flex flex-col items-center gap-2">
                                        <span class="text-2xl">üìñ</span>
                                        <span>‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏•‡∏á</span>
                                        <span class="text-xs opacity-75">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${finalScore.vocabulary}</span>
                                    </button>
                                    <button onclick="goToStep(3)" class="modern-button px-4 py-3 text-sm md:text-base rounded-xl bg-purple-500 hover:bg-purple-600 flex flex-col items-center gap-2">
                                        <span class="text-2xl">‚úçÔ∏è</span>
                                        <span>‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ & ‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°</span>
                                        <span class="text-xs opacity-75">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: -</span>
                                    </button>
                                    <button onclick="goToStep(4)" class="modern-button px-4 py-3 text-sm md:text-base rounded-xl bg-green-500 hover:bg-green-600 flex flex-col items-center gap-2">
                                        <span class="text-2xl">üñºÔ∏è</span>
                                        <span>‡πÄ‡∏õ‡∏¥‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á</span>
                                        <span class="text-xs opacity-75">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: -</span>
                                    </button>
                                </div>
                                
                                <div class="mt-6 text-center">
                                    <button onclick="playAgain()" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-red-500 hover:bg-red-600 w-full md:w-auto">
                                        üîÑ ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
        }

        // Update Back Button
        function updateBackButton() {
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                if (gameState.currentStep > 1 || gameState.stepHistory.length > 0) {
                    backBtn.classList.remove('hidden');
                } else {
                    backBtn.classList.add('hidden');
                }
            }
        }

        // Update Step Indicators
        function updateStepIndicators() {
            const stepTexts = [
                'üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',
                'üìñ ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏•‡∏á',
                '‚úçÔ∏è ‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ & ‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°',
                'üñºÔ∏è ‡πÄ‡∏õ‡∏¥‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á',
                'üìù ‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô',
                'üèÜ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•'
            ];

            for (let i = 1; i <= 6; i++) {
                const stepElement = document.getElementById(`step-${i}`);
                if (stepElement) {
                    stepElement.className = 'step-circle ';
                    
                    if (i < gameState.currentStep) {
                        stepElement.className += 'step-completed';
                    } else if (i === gameState.currentStep) {
                        stepElement.className += 'step-active';
                    } else {
                        stepElement.className += 'step-inactive';
                    }
                }
            }

            // Update mobile step text
            const currentStepText = document.getElementById('currentStepText');
            if (currentStepText && gameState.currentStep >= 1 && gameState.currentStep <= 6) {
                currentStepText.textContent = stepTexts[gameState.currentStep - 1];
            }
        }

        // Attach Word Click Handlers
        function attachWordClickHandlers() {
            const words = document.querySelectorAll('.word-to-find');
            words.forEach(word => {
                word.addEventListener('click', (event) => handleWordClick(word.dataset.word, event));
            });
        }

        // Handle Word Click
        function handleWordClick(word, event) {
            gameState.selectedWord = word;
            const mission = MISSION_DATA.MISSION_01;
            
            // Remove any existing tooltips
            const existingTooltip = document.getElementById('wordTooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }
            
            // Get the clicked element position
            const clickedElement = event.target;
            const rect = clickedElement.getBoundingClientRect();
            
            // Create floating tooltip
            const tooltip = document.createElement('div');
            tooltip.id = 'wordTooltip';
            tooltip.className = 'fixed z-50 tooltip-modern p-4 md:p-8 max-w-sm md:max-w-lg animate-bounce-in';
            
            // Always position in center for better UX
            tooltip.style.cssText = `
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                max-width: 90vw;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            tooltip.innerHTML = `
                <div class="relative">
                    <button onclick="closeTooltip()" class="absolute -top-2 -right-2 w-8 h-8 md:w-10 md:h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold transition-all duration-200 shadow-lg text-sm md:text-base">
                        √ó
                    </button>
                    
                    <div class="mb-4 md:mb-6">
                        <div class="flex items-center gap-3 mb-3 md:mb-4">
                            <span class="text-2xl md:text-3xl">üîç</span>
                            <h3 class="text-lg md:text-xl font-bold text-gray-900">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢</h3>
                        </div>
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-3 md:p-4 rounded-xl text-center">
                            <p class="text-xl md:text-2xl font-bold text-blue-600">"${word}"</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4 md:space-y-6">
                        <div>
                            <label class="block text-gray-700 mb-2 md:mb-3 font-semibold text-sm md:text-base">üí≠ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢</label>
                            <input type="text" id="wordTranslation" class="w-full modern-input p-3 md:p-4 text-sm md:text-base" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö...">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2 md:mb-3 font-semibold text-sm md:text-base">üìö ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</label>
                            <select id="referenceType" class="w-full modern-input p-3 md:p-4 text-sm md:text-base mb-3" onchange="toggleReferenceInput()">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</option>
                                <option value="‡∏£‡∏π‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß">‡∏£‡∏π‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß</option>
                                <option value="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏°‡∏≤">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏°‡∏≤</option>
                            </select>
                            <input type="text" id="wordReference" class="w-full modern-input p-3 md:p-4 text-sm md:text-base hidden" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏° ‡∏£‡∏≤‡∏ä‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô, ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå, ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠">
                        </div>
                    </div>
                    
                    <div class="flex gap-3 md:gap-4 mt-6 md:mt-8">
                        <button onclick="closeTooltip()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-semibold transition-all duration-200 text-sm md:text-base">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                        <button onclick="validateWord()" class="flex-1 modern-button px-4 md:px-6 py-2 md:py-3 rounded-xl text-sm md:text-base">
                            ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(tooltip);
            
            // Adjust position if tooltip goes off screen (desktop only)
            if (window.innerWidth > 768) {
                setTimeout(() => {
                    const tooltipRect = tooltip.getBoundingClientRect();
                    if (tooltipRect.right > window.innerWidth) {
                        tooltip.style.left = (rect.left - tooltipRect.width - 15) + 'px';
                    }
                    if (tooltipRect.bottom > window.innerHeight) {
                        tooltip.style.top = (rect.bottom - tooltipRect.height) + 'px';
                    }
                    if (tooltipRect.top < 0) {
                        tooltip.style.top = '10px';
                    }
                }, 10);
            }
        }

        // Toggle Reference Input
        function toggleReferenceInput() {
            const referenceType = document.getElementById('referenceType').value;
            const referenceInput = document.getElementById('wordReference');
            
            if (referenceType === '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏°‡∏≤') {
                referenceInput.classList.remove('hidden');
                referenceInput.required = true;
            } else {
                referenceInput.classList.add('hidden');
                referenceInput.required = false;
                referenceInput.value = '';
            }
        }

        // Validate Word Translation
        async function validateWord() {
            try {
                const translation = document.getElementById('wordTranslation').value.trim();
                const referenceType = document.getElementById('referenceType').value;
                const referenceInput = document.getElementById('wordReference').value.trim();
                const mission = MISSION_DATA.MISSION_01;
                const correctMeaning = mission.hardWords[gameState.selectedWord].meaning;
                
                // Validation checks
                if (!translation || translation.length < 2) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå', 'error');
                    return;
                }
                
                if (!referenceType) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á', 'error');
                    return;
                }
                
                if (referenceType === '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏°‡∏≤' && (!referenceInput || referenceInput.trim() === '')) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'error');
                    return;
                }
                
                const finalReference = referenceType === '‡∏£‡∏π‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß' ? '‡∏£‡∏π‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß' : referenceInput;
                
                // Check if translation contains key concepts (more flexible matching)
                const correctMeanings = mission.hardWords[gameState.selectedWord].meaning.split(',').map(m => m.trim());
                const hasKeyword = correctMeanings.some(meaning => {
                    const keywords = meaning.split(' ');
                    return keywords.some(keyword => 
                        translation.toLowerCase().includes(keyword.toLowerCase()) ||
                        keyword.toLowerCase().includes(translation.toLowerCase()) ||
                        translation.toLowerCase() === meaning.toLowerCase()
                    );
                });
                
                const wordElement = document.querySelector(`[data-word="${gameState.selectedWord}"]`);
                
                if (!hasKeyword) {
                    // Track incorrect attempts
                    if (!gameState.wordAttempts[gameState.selectedWord]) {
                        gameState.wordAttempts[gameState.selectedWord] = 0;
                    }
                    gameState.wordAttempts[gameState.selectedWord]++;
                    
                    // Mark as incorrect
                    gameState.incorrectWords[gameState.selectedWord] = {
                        translation: translation,
                        reference: finalReference,
                        timestamp: new Date().toISOString(),
                        correctMeaning: correctMeaning,
                        attempts: gameState.wordAttempts[gameState.selectedWord]
                    };
                    
                    if (wordElement) {
                        wordElement.className = 'word-incorrect';
                    }
                    
                    // Save immediately to database
                    await saveCurrentGameState();
                    await saveAllUserAnswers();
                    
                    // Show hint image after 2 incorrect attempts
                    let hintMessage = `‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏•‡∏≠‡∏á‡∏î‡∏π‡πÉ‡∏ö‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö`;
                    if (gameState.wordAttempts[gameState.selectedWord] >= 2) {
                        hintMessage += ` (‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡πâ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è)`;
                        
                        // Add floating hint image to the word in the poem
                        const hintImageContainer = document.createElement('div');
                        hintImageContainer.className = 'absolute z-10 hint-image';
                        hintImageContainer.style.cssText = `
                            top: -80px;
                            left: 50%;
                            transform: translateX(-50%);
                            pointer-events: none;
                        `;
                        hintImageContainer.innerHTML = `
                            <div class="relative">
                                <img src="${getWordImage(gameState.selectedWord)}" alt="‡πÉ‡∏ö‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${gameState.selectedWord}" 
                                     class="w-16 h-16 md:w-20 md:h-20 rounded-xl border-4 border-yellow-400 object-cover shadow-2xl animate-pulse bg-white p-1">
                                <div class="absolute -top-2 -right-2 w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center text-xs font-bold text-yellow-900">üí°</div>
                            </div>
                        `;
                        
                        // Insert hint image as floating element
                        if (wordElement && !wordElement.parentElement.querySelector('.hint-image')) {
                            wordElement.parentElement.style.position = 'relative';
                            wordElement.parentElement.appendChild(hintImageContainer);
                        }
                    }
                    
                    showNotification(hintMessage, 'error');
                    updateWordCounts();
                    closeTooltip();
                    return;
                }
                
                // Mark word as translated correctly
                gameState.translatedWords[gameState.selectedWord] = {
                    translation: translation,
                    reference: finalReference,
                    points: mission.hardWords[gameState.selectedWord].points,
                    timestamp: new Date().toISOString(),
                    correctMeaning: correctMeaning
                };
                
                // Remove from incorrect if it was there
                delete gameState.incorrectWords[gameState.selectedWord];
                
                // Update UI
                if (wordElement) {
                    wordElement.className = 'word-correct';
                }
                
                // Save immediately to database
                await saveCurrentGameState();
                await saveAllUserAnswers();
                
                updateWordCounts();
                showNotification(`üéâ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! +${mission.hardWords[gameState.selectedWord].points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, 'success');
                closeTooltip();
                
                // Check if all words are translated
                const foundWordsCount = Object.keys(gameState.translatedWords).length;
                const totalWords = Object.keys(mission.hardWords).length;
                
                if (foundWordsCount === totalWords) {
                    setTimeout(() => {
                        showNotification('üöÄ ‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                        checkAllWordsFound();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error validating word:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö', 'error');
            }
        }

        // Update Word Counts
        function updateWordCounts() {
            const mission = MISSION_DATA.MISSION_01;
            const foundWordsCount = Object.keys(gameState.translatedWords).length;
            const incorrectWordsCount = Object.keys(gameState.incorrectWords).length;
            const totalWords = Object.keys(mission.hardWords).length;
            const progressPercent = (foundWordsCount / totalWords) * 100;
            
            const foundWordsElement = document.getElementById('foundWords');
            const incorrectWordsElement = document.getElementById('incorrectWords');
            const progressFill = document.getElementById('wordProgress');
            
            if (foundWordsElement) {
                foundWordsElement.textContent = foundWordsCount;
            }
            if (incorrectWordsElement) {
                incorrectWordsElement.textContent = incorrectWordsCount;
            }
            if (progressFill) {
                progressFill.style.width = progressPercent + '%';
            }
        }

        // Check if all words are found
        function checkAllWordsFound() {
            const mission = MISSION_DATA.MISSION_01;
            const foundWordsCount = Object.keys(gameState.translatedWords).length;
            const totalWords = Object.keys(mission.hardWords).length;
            
            const nextButton = document.getElementById('nextToMatching');
            if (nextButton && foundWordsCount === totalWords) {
                nextButton.classList.remove('hidden');
                showNotification('üéâ ‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡πÅ‡∏•‡πâ‡∏ß! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏õ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå', 'success');
            }
        }

        // Show Matching Game
        async function showMatchingGame() {
            await renderStep(2.5); // New step for matching game
        }

        // Show User Menu
        function showUserMenu() {
            const modal = document.createElement('div');
            modal.id = 'userMenuModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 md:p-8 max-w-md w-full animate-bounce-in">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4">üë§</div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
                        <p class="text-gray-600">${gameState.currentUser?.name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}</p>
                        ${gameState.currentUser?.studentId ? `<p class="text-sm text-gray-500">${gameState.currentUser.grade}/${gameState.currentUser.room} ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${gameState.currentUser.number}</p>` : ''}
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-4 rounded-xl">
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-bold text-blue-600">${playerProfile.exp}</div>
                                    <div class="text-sm text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</div>
                                </div>
                                <div>
                                    <div class="text-xl font-bold text-purple-600">${playerProfile.rank}</div>
                                    <div class="text-sm text-gray-600">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="userMenuGoHome()" class="flex-1 modern-button px-4 py-3 rounded-xl bg-blue-500 hover:bg-blue-600">
                                üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                            </button>
                            <button onclick="userMenuSignOut()" class="flex-1 modern-button px-4 py-3 rounded-xl bg-red-500 hover:bg-red-600">
                                üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                            </button>
                        </div>
                        
                        <button onclick="closeUserMenu()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                            ‡∏õ‡∏¥‡∏î
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close User Menu
        function closeUserMenu() {
            const modal = document.getElementById('userMenuModal');
            if (modal) {
                modal.remove();
            }
        }

        // User Menu Functions
        async function userMenuGoHome() {
            closeUserMenu();
            await goToHome();
        }

        async function userMenuSignOut() {
            closeUserMenu();
            await signOutUser();
            showLandingPage();
        }

        // Evaluate Creative Writing with Real-time AI-like Scoring
        function evaluateCreativeWriting(text, type) {
            const keywords = {
                imagination: [
                    '‡∏ä‡πâ‡∏≤‡∏á', '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢', '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏õ‡∏£', '‡∏á‡πâ‡∏≤‡∏ß', '‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°', '‡∏£‡∏ö', '‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ',
                    '‡∏≠‡∏Å', '‡πÄ‡∏•‡∏∑‡∏≠‡∏î', '‡∏ï‡∏≤‡∏¢', '‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç', '‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏•‡∏∞', '‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á', '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏≤‡∏°‡∏µ',
                    '‡∏®‡∏±‡∏ï‡∏£‡∏π', '‡∏û‡∏°‡πà‡∏≤', '‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', '‡πÇ‡∏≠‡∏£‡∏™', '‡∏û‡∏£‡∏∞‡∏®‡∏û', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏±‡∏Å‡∏î‡∏µ',
                    '‡∏ô‡∏á‡∏Ñ‡∏£‡∏≤‡∏ç', '‡∏Å‡∏£‡∏∞‡∏©‡∏±‡∏ï‡∏£‡∏µ‡∏¢‡πå', '‡∏°‡∏≤‡∏ô', '‡∏Å‡∏±‡∏ï‡πÄ‡∏ß‡∏ó‡∏µ', '‡∏°‡∏•‡∏≤‡∏¢', '‡∏Ñ‡πÄ‡∏ä‡∏ô‡∏ó‡∏£', '‡∏î‡∏±‡∏™‡∏Å‡∏£', '‡πÅ‡∏•‡πà‡∏á', '‡∏≠‡∏∏‡∏£‡∏∞', '‡∏´‡∏£‡∏∏‡∏ö', '‡∏û‡∏à‡∏ô‡πå'
                ],
                interpretation: [
                    // Core semantic lexicon for interpretation evaluation
                    '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à', '‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢', '‡πÄ‡∏Å‡∏£‡∏á', '‡∏û‡∏£‡∏∞‡∏™‡∏ß‡∏≤‡∏°‡∏µ', '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏≤‡∏°‡∏µ', '‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå', '‡∏ï‡∏≤‡∏¢', '‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï',
                    '‡∏Ç‡∏±‡∏ö', '‡∏ä‡πâ‡∏≤‡∏á', '‡∏Ñ‡∏ä', '‡∏´‡∏±‡∏ï‡∏ñ‡∏µ', '‡πÄ‡∏Ç‡πâ‡∏≤', '‡∏Ç‡∏ß‡∏≤‡∏á', '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏õ‡∏£', '‡πÅ‡∏õ‡∏£', '‡∏°‡∏≠‡∏ç', '‡∏û‡∏°‡πà‡∏≤', '‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ', '‡∏£‡∏ö',
                    '‡∏á‡πâ‡∏≤‡∏ß', '‡∏ü‡∏±‡∏ô', '‡∏ú‡πà‡∏≤', '‡∏≠‡∏Å', '‡∏≠‡∏∏‡∏£‡∏∞', '‡∏ó‡∏£‡∏ß‡∏á', '‡∏ö‡∏ô', '‡∏Ñ‡∏≠', '‡πÇ‡∏≠‡∏£‡∏™', '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™', '‡∏ö‡∏∏‡∏ï‡∏£',
                    '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡πÄ‡∏°‡∏®‡∏ß‡∏£', '‡∏°‡∏´‡∏¥‡∏ô‡∏ó‡∏£‡∏≤', '‡∏Å‡∏±‡∏ô', '‡∏û‡∏£‡∏∞‡∏®‡∏û', '‡∏ô‡∏≥', '‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏ô‡∏Ñ‡∏£', '‡∏™‡∏£‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏ç', '‡πÄ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠',
                    '‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç', '‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏•‡∏∞', '‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á', '‡∏ß‡∏µ‡∏£‡∏Å‡∏£‡∏£‡∏°', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏±‡∏Å‡∏î‡∏µ'
                ]
            };
            
            const relevantKeywords = keywords[type] || [];
            const textLower = text.toLowerCase();
            let score = 0;
            let foundKeywords = 0;
            let keywordDetails = [];
            
            // Advanced keyword matching with context
            relevantKeywords.forEach(keyword => {
                if (textLower.includes(keyword.toLowerCase())) {
                    foundKeywords++;
                    let points = 5;
                    
                    // Bonus points for important keywords
                    if (['‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢', '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏õ‡∏£', '‡∏á‡πâ‡∏≤‡∏ß', '‡∏ä‡πâ‡∏≤‡∏á'].includes(keyword)) {
                        points = 8;
                    }
                    
                    score += points;
                    keywordDetails.push({ keyword, points });
                }
            });
            
            // Length and structure analysis
            const wordCount = text.trim().split(/\s+/).length;
            const sentences = text.split(/[.!?]/).filter(s => s.trim().length > 0).length;
            
            // Length scoring with better scaling
            if (wordCount >= 100) score += 30;
            else if (wordCount >= 80) score += 25;
            else if (wordCount >= 60) score += 20;
            else if (wordCount >= 40) score += 15;
            else if (wordCount >= 20) score += 10;
            else if (wordCount >= 10) score += 5;
            
            // Structure bonus
            if (sentences >= 3) score += 10;
            else if (sentences >= 2) score += 5;
            
            // Content quality analysis
            const qualityWords = [
                '‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°', '‡∏ô‡πà‡∏≤‡πÄ‡∏Å‡∏£‡∏á‡∏Ç‡∏≤‡∏°', '‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà', '‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏≤‡∏£', '‡∏ô‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°', '‡πÄ‡∏®‡∏£‡πâ‡∏≤‡πÇ‡∏®‡∏Å', '‡∏†‡∏≤‡∏Ñ‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à',
                '‡∏ß‡∏µ‡∏£‡∏Å‡∏£‡∏£‡∏°', '‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏•‡∏∞', '‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏±‡∏Å‡∏î‡∏µ', '‡∏ô‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÉ‡∏à', '‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô‡πÉ‡∏à',
                '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°', '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Å‡∏£‡πà‡∏á', '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏Ç‡πá‡∏á', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á', '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤‡πÇ‡∏®‡∏Å'
            ];
            
            let qualityScore = 0;
            qualityWords.forEach(word => {
                if (textLower.includes(word.toLowerCase())) {
                    qualityScore += 3;
                }
            });
            score += Math.min(qualityScore, 15); // Cap quality bonus
            
            // Creativity and originality bonus
            const creativeElements = [
                '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á', '‡πÅ‡∏™‡∏á‡πÅ‡∏ß‡∏ö', '‡∏ù‡∏∏‡πà‡∏ô‡∏ü‡∏∏‡πâ‡∏á', '‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÑ‡∏´‡∏•', '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤', '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡πâ‡∏≠‡∏á',
                '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∑‡∏î', '‡πÅ‡∏™‡∏á‡πÅ‡∏î‡∏î', '‡∏•‡∏°‡πÅ‡∏£‡∏á', '‡∏ü‡πâ‡∏≤‡∏£‡πâ‡∏≠‡∏á', '‡πÄ‡∏°‡∏Ü‡∏î‡∏≥', '‡∏î‡∏≤‡∏ß‡∏î‡∏ß‡∏á'
            ];
            
            let creativityScore = 0;
            creativeElements.forEach(element => {
                if (textLower.includes(element.toLowerCase())) {
                    creativityScore += 2;
                }
            });
            score += Math.min(creativityScore, 10); // Cap creativity bonus
            
            // Penalty for too short content
            if (wordCount < 10) {
                score = Math.max(0, score - 20);
            }
            
            // Final score calculation with realistic scaling
            const finalScore = Math.min(Math.max(score, 0), 100);
            
            return {
                score: finalScore,
                foundKeywords: foundKeywords,
                wordCount: wordCount,
                sentences: sentences,
                keywordDetails: keywordDetails,
                feedback: generateAdvancedFeedback(finalScore, foundKeywords, wordCount, sentences, type)
            };
        }
        
        function generateAdvancedFeedback(score, keywords, wordCount, sentences, type) {
            let feedback = '';
            let suggestions = [];
            
            // Score-based feedback
            if (score >= 90) {
                feedback = 'üåü ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏¢‡∏≠‡∏î! ';
            } else if (score >= 80) {
                feedback = 'üéâ ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ';
            } else if (score >= 70) {
                feedback = 'üëç ‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ';
            } else if (score >= 60) {
                feedback = 'üòä ‡∏î‡∏µ! ';
            } else if (score >= 50) {
                feedback = 'üëå ‡∏û‡∏≠‡πÉ‡∏ä‡πâ! ';
            } else {
                feedback = 'üí™ ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á! ';
            }
            
            // Content analysis
            if (type === 'imagination') {
                feedback += `‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ${keywords} ‡∏Ñ‡∏≥ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô ${wordCount} ‡∏Ñ‡∏≥ ‡πÉ‡∏ô ${sentences} ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ `;
                
                if (keywords >= 8) {
                    feedback += '‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á ';
                } else if (keywords >= 5) {
                    feedback += '‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏î‡∏µ ';
                    suggestions.push('‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å');
                } else if (keywords >= 3) {
                    feedback += '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏û‡∏≠‡∏™‡∏°‡∏Ñ‡∏ß‡∏£ ';
                    suggestions.push('‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏•‡∏á‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô');
                } else {
                    suggestions.push('‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô');
                    suggestions.push('‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô');
                }
                
                if (wordCount < 30) {
                    suggestions.push('‡∏•‡∏≠‡∏á‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ô‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î');
                }
                
            } else { // interpretation
                feedback += `‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ${keywords} ‡∏Ñ‡∏≥ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô ${wordCount} ‡∏Ñ‡∏≥ ‡πÉ‡∏ô ${sentences} ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ `;
                
                if (keywords >= 10) {
                    feedback += '‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ';
                } else if (keywords >= 7) {
                    feedback += '‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ ';
                    suggestions.push('‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå');
                } else if (keywords >= 5) {
                    feedback += '‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏û‡∏≠‡∏™‡∏°‡∏Ñ‡∏ß‡∏£ ';
                    suggestions.push('‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î');
                } else {
                    suggestions.push('‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏•‡∏á‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô');
                    suggestions.push('‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô');
                }
                
                if (wordCount < 40) {
                    suggestions.push('‡∏•‡∏≠‡∏á‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                }
            }
            
            // Add suggestions to feedback
            if (suggestions.length > 0) {
                feedback += '\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ' + suggestions.join(' ‚Ä¢ ');
            }
            
            return feedback;
        }

        // Setup Step 3 Handlers
        function setupStep3Handlers() {
            const imaginationInput = document.getElementById('imaginationInput');
            const interpretationInput = document.getElementById('interpretationInput');
            const nextBtn = document.getElementById('nextStep3');
            
            // Load saved data
            if (gameState.imaginationText) {
                imaginationInput.value = gameState.imaginationText;
            }
            if (gameState.interpretationText) {
                interpretationInput.value = gameState.interpretationText;
            }
            
            function updateButtonState() {
                const imaginationLength = imaginationInput.value.trim().length;
                const interpretationLength = interpretationInput.value.trim().length;
                
                nextBtn.disabled = imaginationLength < 10 || interpretationLength < 10;
            }
            
            // Initial button state check
            updateButtonState();
            
            imaginationInput.addEventListener('input', async () => {
                gameState.imaginationText = imaginationInput.value;
                updateButtonState();
                
                // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß - ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                
                await saveCurrentGameState();
                await saveAllUserAnswers();
            });
            
            interpretationInput.addEventListener('input', async () => {
                gameState.interpretationText = interpretationInput.value;
                updateButtonState();
                
                // Real-time evaluation
                if (interpretationInput.value.trim().length > 20) {
                    const evaluation = evaluateCreativeWriting(interpretationInput.value, 'interpretation');
                    showWritingFeedback('interpretation', evaluation);
                }
                
                await saveCurrentGameState();
                await saveAllUserAnswers();
            });
            
            nextBtn.addEventListener('click', async () => {
                try {
                    gameState.imaginationText = imaginationInput.value;
                    gameState.interpretationText = interpretationInput.value;
                    
                    // Final evaluation - ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£
                    const interpretationEval = evaluateCreativeWriting(gameState.interpretationText, 'interpretation');
                    
                    gameState.imaginationScore = 0; // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                    gameState.interpretationScore = interpretationEval.score;
                    
                    await saveCurrentGameState();
                    await saveAllUserAnswers();
                    
                    showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°: ${interpretationEval.score}`, 'success');
                    await renderStep(4);
                } catch (error) {
                    console.error('Error saving step 3 data:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            });
        }
        
        function showWritingFeedback(type, evaluation) {
            const containerId = type === 'imagination' ? 'imaginationFeedback' : 'interpretationFeedback';
            let container = document.getElementById(containerId);
            
            if (!container) {
                const inputElement = document.getElementById(type === 'imagination' ? 'imaginationInput' : 'interpretationInput');
                container = document.createElement('div');
                container.id = containerId;
                container.className = 'mt-3 p-4 bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-xl';
                inputElement.parentNode.appendChild(container);
            }
            
            // Determine color based on score
            let scoreColor = 'text-red-600';
            let barColor = 'bg-red-500';
            if (evaluation.score >= 80) {
                scoreColor = 'text-green-600';
                barColor = 'bg-green-500';
            } else if (evaluation.score >= 60) {
                scoreColor = 'text-blue-600';
                barColor = 'bg-blue-500';
            } else if (evaluation.score >= 40) {
                scoreColor = 'text-yellow-600';
                barColor = 'bg-yellow-500';
            }
            
            // Split feedback into main text and suggestions
            const feedbackParts = evaluation.feedback.split('\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ');
            const mainFeedback = feedbackParts[0];
            const suggestions = feedbackParts[1];
            
            container.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="font-bold ${scoreColor} text-lg">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${evaluation.score}/100</span>
                    <div class="w-32 h-3 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full ${barColor} rounded-full transition-all duration-500 ease-out" style="width: ${evaluation.score}%"></div>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <p class="text-sm font-semibold text-blue-800">${mainFeedback}</p>
                    
                    ${evaluation.keywordDetails && evaluation.keywordDetails.length > 0 ? `
                        <div class="text-xs text-gray-600">
                            <span class="font-semibold">‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏û‡∏ö:</span> 
                            ${evaluation.keywordDetails.map(kw => `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full mr-1">${kw.keyword} (+${kw.points})</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    ${suggestions ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mt-2">
                            <div class="flex items-start gap-2">
                                <span class="text-yellow-600 text-lg">üí°</span>
                                <div class="text-xs text-yellow-800">
                                    <span class="font-semibold">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</span><br>
                                    ${suggestions.split(' ‚Ä¢ ').map(s => `‚Ä¢ ${s}`).join('<br>')}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Reveal Image Function with Dust Wiping Effect
        function setupImageReveal() {
            const container = document.getElementById('imageContainer');
            const img = document.getElementById('historicalImage');
            const overlay = document.getElementById('imageOverlay');
            const canvas = document.getElementById('revealCanvas');
            
            if (!container || !img || !overlay || !canvas) return;
            
            const ctx = canvas.getContext('2d');
            let isRevealing = false;
            let revealProgress = 0;
            
            // Set canvas size
            function resizeCanvas() {
                const rect = img.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                
                // Create thicker dusty/foggy overlay effect (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏ô‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô)
                const gradient = ctx.createRadialGradient(
                    canvas.width / 2, canvas.height / 2, 0,
                    canvas.width / 2, canvas.height / 2, Math.max(canvas.width, canvas.height) / 2
                );
                gradient.addColorStop(0, 'rgba(160, 160, 160, 0.95)'); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∂‡∏ö
                gradient.addColorStop(0.5, 'rgba(120, 120, 120, 0.9)'); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∂‡∏ö
                gradient.addColorStop(1, 'rgba(80, 80, 80, 0.85)'); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∂‡∏ö
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Add more dust particles effect (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ù‡∏∏‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
                for (let i = 0; i < 200; i++) { // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 100 ‡πÄ‡∏õ‡πá‡∏ô 200
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const size = Math.random() * 4 + 1; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ù‡∏∏‡πà‡∏ô
                    
                    ctx.fillStyle = `rgba(140, 140, 140, ${Math.random() * 0.7 + 0.4})`; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∂‡∏ö
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Add extra dust layer (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏±‡πâ‡∏ô‡∏ù‡∏∏‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©)
                for (let i = 0; i < 50; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const size = Math.random() * 8 + 3;
                    
                    ctx.fillStyle = `rgba(100, 100, 100, ${Math.random() * 0.4 + 0.2})`;
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Initialize canvas
            img.onload = resizeCanvas;
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            // Update overlay text for dust wiping effect
            overlay.innerHTML = `
                <div class="text-white text-center">
                    <div class="text-4xl mb-2 animate-bounce">üßπ</div>
                    <p class="text-lg font-bold">‡∏õ‡∏±‡∏î‡∏ù‡∏∏‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏†‡∏≤‡∏û</p>
                    <p class="text-sm mt-2 opacity-75">‡∏•‡∏≤‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏¥‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏î‡∏ù‡∏∏‡πà‡∏ô</p>
                </div>
            `;
            
            function startRevealing(e) {
                isRevealing = true;
                canvas.style.opacity = '1';
                canvas.style.pointerEvents = 'auto';
                reveal(e);
                
                // Change cursor to indicate wiping
                container.style.cursor = 'grab';
            }
            
            function reveal(e) {
                if (!isRevealing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                
                // Create wiping effect with smaller brush (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, Math.PI * 2); // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏≤‡∏Å 40 ‡πÄ‡∏õ‡πá‡∏ô 25
                ctx.fill();
                
                // Add wiping trail effect with smaller brush
                if (reveal.lastX !== undefined && reveal.lastY !== undefined) {
                    ctx.lineWidth = 50; // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏≤‡∏Å 80 ‡πÄ‡∏õ‡πá‡∏ô 50
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(reveal.lastX, reveal.lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                }
                
                reveal.lastX = x;
                reveal.lastY = y;
                
                // Check reveal progress every 30 strokes (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 20 ‡πÄ‡∏õ‡πá‡∏ô 30)
                revealProgress += 1;
                if (revealProgress % 30 === 0) {
                    // Check if enough area has been revealed
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const pixels = imageData.data;
                    let transparentPixels = 0;
                    
                    for (let i = 3; i < pixels.length; i += 4) {
                        if (pixels[i] < 128) { // Alpha channel less than 50%
                            transparentPixels++;
                        }
                    }
                    
                    const revealPercentage = (transparentPixels / (pixels.length / 4)) * 100;
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô - ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 70% ‡πÅ‡∏ó‡∏ô 50%
                    if (revealPercentage >= 70) {
                        completeReveal();
                    }
                }
            }
            
            function stopRevealing() {
                isRevealing = false;
                reveal.lastX = undefined;
                reveal.lastY = undefined;
                container.style.cursor = 'pointer';
            }
            
            function completeReveal() {
                img.classList.remove('blur-lg');
                overlay.style.opacity = '0';
                canvas.style.opacity = '0';
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                    canvas.style.pointerEvents = 'none';
                }, 1000);
                
                showNotification('üñºÔ∏è ‡∏õ‡∏±‡∏î‡∏ù‡∏∏‡πà‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏†‡∏≤‡∏û‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢', 'success');
            }
            
            // Mouse events
            container.addEventListener('mousedown', startRevealing);
            container.addEventListener('mousemove', reveal);
            container.addEventListener('mouseup', stopRevealing);
            container.addEventListener('mouseleave', stopRevealing);
            
            // Touch events
            container.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startRevealing(e);
            });
            container.addEventListener('touchmove', (e) => {
                e.preventDefault();
                reveal(e);
            });
            container.addEventListener('touchend', stopRevealing);
            
            // Click to complete reveal
            container.addEventListener('click', completeReveal);
        }

        // Setup Step 4 Handlers
        function setupStep4Handlers() {
            // Check if user has completed step 3 (imagination and interpretation)
            const hasRequiredData = gameState.imaginationText && gameState.interpretationText && 
                                  gameState.imaginationText.trim().length >= 10 && 
                                  gameState.interpretationText.trim().length >= 10;
            
            if (!hasRequiredData) {
                // Disable image reveal if no step 3 data
                const imageContainer = document.getElementById('imageContainer');
                const overlay = document.getElementById('imageOverlay');
                
                if (imageContainer && overlay) {
                    imageContainer.style.pointerEvents = 'none';
                    overlay.innerHTML = `
                        <div class="text-white text-center">
                            <div class="text-4xl mb-2">üîí</div>
                            <p class="text-lg font-bold">‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ & ‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô</p>
                            <p class="text-sm mt-2 opacity-75">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 3 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°</p>
                            <button onclick="goToStep(3)" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl">
                                ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ & ‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°
                            </button>
                        </div>
                    `;
                }
                
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ & ‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            document.getElementById('showComparison').addEventListener('click', () => {
                const comparisonSection = document.getElementById('comparisonSection');
                const button = document.getElementById('showComparison');
                
                comparisonSection.classList.remove('hidden');
                comparisonSection.classList.add('animate-bounce-in');
                button.style.display = 'none';
                
                showNotification('‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á!', 'success');
            });
            
            document.getElementById('nextStep4').addEventListener('click', async () => {
                await renderStep(5);
            });
        }

        // Get Word Emoji
        function getWordEmoji(word) {
            const emojiMap = {
                '‡∏ô‡∏á‡∏Ñ‡∏£‡∏≤‡∏ç': 'üë∏',
                '‡∏°‡∏≤‡∏ô': 'üíñ',
                '‡∏Å‡∏±‡∏ï‡πÄ‡∏ß‡∏ó‡∏µ': 'üôè',
                '‡∏°‡∏•‡∏≤‡∏¢': 'üíÄ',
                '‡∏Ñ‡πÄ‡∏ä‡∏ô‡∏ó‡∏£': 'üêò',
                '‡∏î‡∏±‡∏™‡∏Å‡∏£': '‚öîÔ∏è',
                '‡πÅ‡∏•‡πà‡∏á': 'üî™',
                '‡∏≠‡∏∏‡∏£‡∏∞': 'üë§',
                '‡∏´‡∏£‡∏∏‡∏ö': '‚¨áÔ∏è',
                '‡πÑ‡∏õ‡πà': '‚ùå',
                '‡∏û‡∏à‡∏ô‡πå': 'üí¨'
            };
            return emojiMap[word] || 'üìù';
        }

        // Get Word Image
        function getWordImage(word) {
            const imageMap = {
                '‡∏ô‡∏á‡∏Ñ‡∏£‡∏≤‡∏ç': 'https://img2.pic.in.th/pic/Gemini_Generated_Image_obzx9bobzx9bobzx.png',
                '‡∏°‡∏≤‡∏ô': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_xvra5axvra5axvra.png',
                '‡∏Å‡∏±‡∏ï‡πÄ‡∏ß‡∏ó‡∏µ': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_npiozbnpiozbnpioc4686b30823835e2.png',
                '‡∏°‡∏•‡∏≤‡∏¢': 'https://img2.pic.in.th/pic/Gemini_Generated_Image_5dg3t75dg3t75dg3084de5b3dbf1da5a.png',
                '‡∏Ñ‡πÄ‡∏ä‡∏ô‡∏ó‡∏£': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_2w0xpa2w0xpa2w0x6d96eebaef1428c5.png',
                '‡∏î‡∏±‡∏™‡∏Å‡∏£': 'https://img2.pic.in.th/pic/Gemini_Generated_Image_m7s5sjm7s5sjm7s5.png',
                '‡∏á‡πâ‡∏≤‡∏ß': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_wwh7v4wwh7v4wwh7.png',
                '‡πÅ‡∏•‡πà‡∏á': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_nofldgnofldgnofl.png',
                '‡∏≠‡∏∏‡∏£‡∏∞': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_1tpy7b1tpy7b1tpy.png',
                '‡∏´‡∏£‡∏∏‡∏ö': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_n464d3n464d3n464.png',
                '‡πÑ‡∏õ‡πà': 'https://img2.pic.in.th/pic/Gemini_Generated_Image_jij2fajij2fajij2.png',
                '‡∏û‡∏à‡∏ô‡πå': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_o6l06zo6l06zo6l0.png'
            };
            return imageMap[word] || '';
        }

        // Setup Quiz
        function setupQuiz() {
            // Load saved quiz answers if available
            if (gameState.comprehensionAnswers && gameState.comprehensionAnswers.length > 0) {
                gameState.comprehensionAnswers.forEach((answer, index) => {
                    const radio = document.querySelector(`input[name="question_${index}"][value="${answer}"]`);
                    if (radio) {
                        radio.checked = true;
                    }
                });
                
                // Show score if already checked
                if (gameState.comprehensionScore !== undefined) {
                    document.getElementById('quizScore').textContent = gameState.comprehensionScore;
                    document.getElementById('checkAnswers').classList.add('hidden');
                    document.getElementById('finishQuiz').classList.remove('hidden');
                }
            }
        }

        // Check Quiz Answers
        function checkQuizAnswers() {
            const mission = MISSION_DATA.MISSION_01;
            let score = 0;
            const answers = [];
            
            mission.comprehensionQuestions.forEach((q, index) => {
                const selectedRadio = document.querySelector(`input[name="question_${index}"]:checked`);
                const resultDiv = document.getElementById(`result_${index}`);
                
                if (selectedRadio) {
                    const selectedValue = parseInt(selectedRadio.value);
                    answers.push(selectedValue);
                    
                    if (selectedValue === q.correct) {
                        score++;
                        resultDiv.innerHTML = '<div class="text-green-600 font-semibold">‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!</div>';
                        resultDiv.classList.remove('hidden');
                        selectedRadio.parentElement.classList.add('bg-green-100', 'border-green-300');
                    } else {
                        resultDiv.innerHTML = `<div class="text-red-600 font-semibold">‚ùå ‡∏ú‡∏¥‡∏î! ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å: ${q.options[q.correct]}</div>`;
                        resultDiv.classList.remove('hidden');
                        selectedRadio.parentElement.classList.add('bg-red-100', 'border-red-300');
                        
                        // Highlight correct answer
                        const correctRadio = document.querySelector(`input[name="question_${index}"][value="${q.correct}"]`);
                        if (correctRadio) {
                            correctRadio.parentElement.classList.add('bg-green-100', 'border-green-300');
                        }
                    }
                } else {
                    answers.push(-1);
                    resultDiv.innerHTML = '<div class="text-orange-600 font-semibold">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</div>';
                    resultDiv.classList.remove('hidden');
                }
            });
            
            // Save answers and score
            gameState.comprehensionAnswers = answers;
            gameState.comprehensionScore = score;
            
            // Update UI
            document.getElementById('quizScore').textContent = score;
            document.getElementById('checkAnswers').classList.add('hidden');
            
            // Check if score is less than half
            const halfScore = Math.ceil(mission.comprehensionQuestions.length / 2);
            if (score < halfScore) {
                // Show retry button for low scores
                document.getElementById('retryQuiz').classList.remove('hidden');
                showNotification(`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}/${mission.comprehensionQuestions.length} ‡∏Ç‡πâ‡∏≠ - ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏£‡∏∂‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô`, 'error');
            } else {
                // Show finish button for good scores
                document.getElementById('finishQuiz').classList.remove('hidden');
                showNotification(`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}/${mission.comprehensionQuestions.length} ‡∏Ç‡πâ‡∏≠ - ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå!`, 'success');
            }
            
            // Disable all radio buttons
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.disabled = true;
            });
            
            // Save to database
            saveCurrentGameState();
            saveAllUserAnswers();
        }

        // Retry Quiz
        function retryQuiz() {
            // Clear all selections and results
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
                radio.disabled = false;
                radio.parentElement.classList.remove('bg-green-100', 'border-green-300', 'bg-red-100', 'border-red-300');
            });
            
            // Hide all result divs
            document.querySelectorAll('[id^="result_"]').forEach(resultDiv => {
                resultDiv.classList.add('hidden');
                resultDiv.innerHTML = '';
            });
            
            // Reset UI buttons
            document.getElementById('checkAnswers').classList.remove('hidden');
            document.getElementById('retryQuiz').classList.add('hidden');
            document.getElementById('finishQuiz').classList.add('hidden');
            
            // Reset score display
            document.getElementById('quizScore').textContent = '0';
            
            // Clear saved answers
            gameState.comprehensionAnswers = [];
            gameState.comprehensionScore = 0;
            
            showNotification('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà!', 'success');
        }

        // Finish Quiz
        async function finishQuiz() {
            await renderStep(6);
        }

        // Setup Matching Game
        function setupMatchingGame() {
            let selectedWord = null;
            let matchedPairs = 0;
            let score = 0;
            const mission = MISSION_DATA.MISSION_01;
            const totalPairs = Object.keys(mission.hardWords).length;
            
            // Load saved matching state if available
            if (gameState.matchingScore !== undefined) {
                score = gameState.matchingScore;
                matchedPairs = gameState.matchedPairs || 0;
                updateMatchingScore();
            }
            
            function updateMatchingScore() {
                document.getElementById('matchingScore').textContent = score;
                
                // Enable finish button when all pairs are matched
                const finishBtn = document.getElementById('finishMatching');
                if (matchedPairs >= totalPairs) {
                    finishBtn.disabled = false;
                    finishBtn.textContent = '‚û°Ô∏è ‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
                    showNotification('üéâ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                }
            }
            
            // Word click handler
            document.querySelectorAll('.word-item').forEach(wordEl => {
                wordEl.addEventListener('click', () => {
                    // Remove previous selection
                    document.querySelectorAll('.word-item').forEach(el => {
                        el.classList.remove('bg-purple-200', 'border-purple-500');
                    });
                    
                    // Select current word
                    wordEl.classList.add('bg-purple-200', 'border-purple-500');
                    selectedWord = wordEl.dataset.word;
                });
            });
            
            // Meaning click handler
            document.querySelectorAll('.meaning-item').forEach(meaningEl => {
                meaningEl.addEventListener('click', () => {
                    if (!selectedWord) {
                        showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Å‡πà‡∏≠‡∏ô', 'error');
                        return;
                    }
                    
                    const correctWord = meaningEl.dataset.word;
                    
                    if (selectedWord === correctWord) {
                        // Correct match
                        const wordEl = document.querySelector(`[data-word="${selectedWord}"]`);
                        
                        // Update UI for correct match
                        meaningEl.classList.remove('border-dashed', 'border-green-300');
                        meaningEl.classList.add('bg-green-200', 'border-green-500', 'border-solid');
                        meaningEl.innerHTML = `
                            <div class="flex flex-col items-center justify-center gap-2">
                                <img src="${getWordImage(selectedWord)}" alt="${selectedWord}" class="w-16 h-16 md:w-20 md:h-20 rounded-lg border-2 border-green-600 object-cover shadow-md">
                                <span class="font-bold text-green-800 text-lg">${selectedWord}</span>
                                <span class="text-green-700 text-sm">${mission.hardWords[selectedWord].meaning}</span>
                            </div>
                        `;
                        
                        // Remove word from left column
                        wordEl.style.opacity = '0.3';
                        wordEl.style.pointerEvents = 'none';
                        wordEl.classList.remove('bg-gradient-to-r', 'from-red-400', 'to-red-500', 'hover:from-red-500', 'hover:to-red-600');
                        wordEl.classList.add('bg-gray-400', 'text-gray-600');
                        
                        matchedPairs++;
                        score += mission.hardWords[selectedWord].points;
                        
                        // Save progress
                        gameState.matchingScore = score;
                        gameState.matchedPairs = matchedPairs;
                        saveCurrentGameState();
                        
                        showNotification(`‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! +${mission.hardWords[selectedWord].points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, 'success');
                        updateMatchingScore();
                        
                    } else {
                        // Incorrect match
                        meaningEl.classList.add('bg-red-100', 'border-red-400');
                        setTimeout(() => {
                            meaningEl.classList.remove('bg-red-100', 'border-red-400');
                        }, 1000);
                        
                        showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                    }
                    
                    // Clear selection
                    selectedWord = null;
                    document.querySelectorAll('.word-item').forEach(el => {
                        el.classList.remove('bg-purple-200', 'border-purple-500');
                    });
                });
            });
            
            // Drag and drop handlers
            document.querySelectorAll('.word-item').forEach(wordEl => {
                wordEl.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', wordEl.dataset.word);
                    wordEl.classList.add('opacity-50');
                });
                
                wordEl.addEventListener('dragend', () => {
                    wordEl.classList.remove('opacity-50');
                });
            });
            
            document.querySelectorAll('.meaning-item').forEach(meaningEl => {
                meaningEl.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    meaningEl.classList.add('bg-green-100', 'border-green-400');
                });
                
                meaningEl.addEventListener('dragleave', () => {
                    meaningEl.classList.remove('bg-green-100', 'border-green-400');
                });
                
                meaningEl.addEventListener('drop', (e) => {
                    e.preventDefault();
                    meaningEl.classList.remove('bg-green-100', 'border-green-400');
                    
                    const draggedWord = e.dataTransfer.getData('text/plain');
                    const correctWord = meaningEl.dataset.word;
                    
                    if (draggedWord === correctWord) {
                        // Same logic as click handler for correct match
                        const wordEl = document.querySelector(`[data-word="${draggedWord}"]`);
                        
                        meaningEl.classList.remove('border-dashed', 'border-green-300');
                        meaningEl.classList.add('bg-green-200', 'border-green-500', 'border-solid');
                        meaningEl.innerHTML = `
                            <div class="flex flex-col items-center justify-center gap-2">
                                <img src="${getWordImage(draggedWord)}" alt="${draggedWord}" class="w-16 h-16 md:w-20 md:h-20 rounded-lg border-2 border-green-600 object-cover shadow-md">
                                <span class="font-bold text-green-800 text-lg">${draggedWord}</span>
                                <span class="text-green-700 text-sm">${mission.hardWords[draggedWord].meaning}</span>
                            </div>
                        `;
                        
                        wordEl.style.opacity = '0.3';
                        wordEl.style.pointerEvents = 'none';
                        wordEl.classList.remove('bg-gradient-to-r', 'from-red-400', 'to-red-500', 'hover:from-red-500', 'hover:to-red-600');
                        wordEl.classList.add('bg-gray-400', 'text-gray-600');
                        
                        matchedPairs++;
                        score += mission.hardWords[draggedWord].points;
                        
                        gameState.matchingScore = score;
                        gameState.matchedPairs = matchedPairs;
                        saveCurrentGameState();
                        
                        showNotification(`‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! +${mission.hardWords[draggedWord].points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, 'success');
                        updateMatchingScore();
                        
                    } else {
                        meaningEl.classList.add('bg-red-100', 'border-red-400');
                        setTimeout(() => {
                            meaningEl.classList.remove('bg-red-100', 'border-red-400');
                        }, 1000);
                        
                        showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                    }
                });
            });
            
            // Reset button
            document.getElementById('resetMatching').addEventListener('click', () => {
                if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    location.reload(); // Simple reset by reloading
                }
            });
            
            // Finish button
            document.getElementById('finishMatching').addEventListener('click', async () => {
                gameState.matchingScore = score;
                await saveCurrentGameState();
                await saveAllUserAnswers();
                
                showNotification('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå!', 'success');
                await renderStep(3); // Go to next step
            });
            
            // Initial score update
            updateMatchingScore();
        }

        // Go to specific step
        async function goToStep(step) {
            await renderStep(step);
        }

        // Update user name display
        function updateUserNameDisplay() {
            const headerUserName = document.getElementById('headerUserName');
            const currentUserName = document.getElementById('currentUserName');
            
            if (gameState.currentUser && headerUserName && currentUserName) {
                headerUserName.classList.remove('hidden');
                currentUserName.textContent = gameState.currentUser.name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            } else if (headerUserName) {
                headerUserName.classList.add('hidden');
            }
        }

        // Certificate Generation
        function generateCertificate() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = 1200;
            canvas.height = 800;
            
            // Background gradient
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(0.5, '#764ba2');
            gradient.addColorStop(1, '#f093fb');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Border
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 8;
            ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);
            
            // Inner border
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 2;
            ctx.strokeRect(60, 60, canvas.width - 120, canvas.height - 120);
            
            // Title
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 48px Sarabun, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£', canvas.width / 2, 150);
            
            ctx.font = 'bold 36px Sarabun, Arial, sans-serif';
            ctx.fillText('‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ', canvas.width / 2, 200);
            
            // Decorative line
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(300, 220);
            ctx.lineTo(900, 220);
            ctx.stroke();
            
            // Certificate text
            ctx.font = '28px Sarabun, Arial, sans-serif';
            ctx.fillText('‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏Å‡∏±‡∏ö', canvas.width / 2, 280);
            
            // Student name
            const studentName = gameState.currentUser?.name || '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
            ctx.font = 'bold 42px Sarabun, Arial, sans-serif';
            ctx.fillStyle = '#ffeb3b';
            ctx.fillText(studentName, canvas.width / 2, 340);
            
            // Student details
            if (gameState.currentUser?.studentId) {
                ctx.font = '24px Sarabun, Arial, sans-serif';
                ctx.fillStyle = '#ffffff';
                const studentDetails = `‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${gameState.currentUser.studentId} | ‡∏ä‡∏±‡πâ‡∏ô: ${gameState.currentUser.grade}/${gameState.currentUser.room} ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${gameState.currentUser.number}`;
                ctx.fillText(studentDetails, canvas.width / 2, 380);
            }
            
            // Achievement text
            ctx.font = '28px Sarabun, Arial, sans-serif';
            ctx.fillStyle = '#ffffff';
            ctx.fillText('‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ', canvas.width / 2, 440);
            ctx.fillText('‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û - ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏û‡∏á‡∏®‡∏≤‡∏ß‡∏î‡∏≤‡∏£', canvas.width / 2, 480);
            
            // Score details
            ctx.font = 'bold 32px Sarabun, Arial, sans-serif';
            ctx.fillStyle = '#4caf50';
            ctx.fillText(`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${playerProfile.exp} ‡πÅ‡∏ï‡πâ‡∏°`, canvas.width / 2, 540);
            
            ctx.font = '24px Sarabun, Arial, sans-serif';
            ctx.fillStyle = '#ffffff';
            ctx.fillText(`‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö: ${playerProfile.rank} | ‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô: ${playerProfile.totalGamesPlayed} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`, canvas.width / 2, 580);
            
            // Date
            ctx.font = '20px Sarabun, Arial, sans-serif';
            const currentDate = new Date().toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            ctx.fillText(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${currentDate}`, canvas.width / 2, 640);
            
            // Signature area
            ctx.font = '18px Sarabun, Arial, sans-serif';
            ctx.fillText('‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ‡πÑ‡∏ó‡∏¢‡πÅ‡∏ö‡∏ö‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö', canvas.width / 2, 720);
            
            // Add decorative elements
            ctx.fillStyle = '#ffeb3b';
            ctx.font = '60px Arial';
            ctx.fillText('üèÜ', 200, 350);
            ctx.fillText('üèÜ', 1000, 350);
            
            ctx.fillText('üìö', 150, 500);
            ctx.fillText('üìö', 1050, 500);
            
            return canvas;
        }

        // Play Again Function
        async function playAgain() {
            try {
                // Save final game data before resetting
                await saveAllUserAnswers();
                
                // Clear old game session
                if (gameState.gameId) {
                    await clearGameSession(gameState.gameId);
                }
                
                // Reset game state completely
                gameState.currentStep = 1;
                gameState.translatedWords = {};
                gameState.incorrectWords = {};
                gameState.wordAttempts = {};
                gameState.imaginationText = '';
                gameState.interpretationText = '';
                gameState.comprehensionScore = 0;
                gameState.startTime = Date.now();
                gameState.selectedWord = null;
                gameState.stepHistory = [];
                gameState.comprehensionAnswers = [];
                gameState.gameId = generateGameId();
                
                // Show landing page with start button
                showLandingPage();
                showNotification('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'success');
                
            } catch (error) {
                console.error('Error in play again:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà', 'error');
            }
        }

        // Show Certificate Modal
        function showCertificate() {
            const modal = document.createElement('div');
            modal.id = 'certificateModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            
            const studentName = gameState.currentUser?.name || '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
            const studentDetails = gameState.currentUser?.studentId ? 
                `‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${gameState.currentUser.studentId} | ‡∏ä‡∏±‡πâ‡∏ô: ${gameState.currentUser.grade}/${gameState.currentUser.room} ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${gameState.currentUser.number}` : 
                '‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
            
            const currentDate = new Date().toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 md:p-10 max-w-4xl w-full max-h-90vh overflow-y-auto animate-bounce-in relative">
                    <button onclick="closeCertificateModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold transition-all duration-200 shadow-lg text-lg z-10">
                        √ó
                    </button>
                    
                    <!-- Certificate Design -->
                    <div class="bg-gradient-to-br from-blue-100 via-purple-50 to-pink-100 border-8 border-yellow-400 rounded-3xl p-8 md:p-12 text-center relative overflow-hidden">
                        <!-- Decorative corners -->
                        <div class="absolute top-4 left-4 text-4xl">üèÜ</div>
                        <div class="absolute top-4 right-4 text-4xl">üèÜ</div>
                        <div class="absolute bottom-4 left-4 text-4xl">üìö</div>
                        <div class="absolute bottom-4 right-4 text-4xl">üìö</div>
                        
                        <!-- Header -->
                        <div class="mb-8">
                            <div class="text-6xl mb-4">üéì</div>
                            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-2">‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£</h1>
                            <h2 class="text-2xl md:text-3xl font-bold text-blue-600">‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ</h2>
                            <div class="w-32 h-1 bg-gradient-to-r from-blue-500 to-purple-500 mx-auto mt-4 rounded-full"></div>
                        </div>
                        
                        <!-- Content -->
                        <div class="space-y-6">
                            <p class="text-xl md:text-2xl text-gray-700">‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏Å‡∏±‡∏ö</p>
                            
                            <div class="bg-white bg-opacity-80 rounded-2xl p-6 border-2 border-yellow-300">
                                <h3 class="text-3xl md:text-4xl font-bold text-purple-600 mb-2">${studentName}</h3>
                                <p class="text-lg text-gray-600">${studentDetails}</p>
                            </div>
                            
                            <div class="space-y-4">
                                <p class="text-xl text-gray-700">‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</p>
                                <p class="text-2xl font-bold text-blue-600">‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û - ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏û‡∏á‡∏®‡∏≤‡∏ß‡∏î‡∏≤‡∏£</p>
                                <p class="text-xl text-gray-700">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏£‡∏¥‡πÇ‡∏¢‡∏ó‡∏±‡∏¢</p>
                            </div>
                            
                            <!-- Score Section -->
                            <div class="bg-gradient-to-r from-green-100 to-blue-100 rounded-2xl p-6 border-2 border-green-300">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                    <div>
                                        <div class="text-3xl font-bold text-green-600">${playerProfile.exp}</div>
                                        <div class="text-sm text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-blue-600">${playerProfile.rank}</div>
                                        <div class="text-sm text-gray-600">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-purple-600">Lv.${playerProfile.level}</div>
                                        <div class="text-sm text-gray-600">‡πÄ‡∏•‡πÄ‡∏ß‡∏•</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Date and Signature -->
                            <div class="space-y-4 mt-8">
                                <p class="text-lg text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${currentDate}</p>
                                <div class="border-t-2 border-gray-300 pt-4">
                                    <p class="text-base text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ‡πÑ‡∏ó‡∏¢‡πÅ‡∏ö‡∏ö‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö</p>
                                    <p class="text-sm text-gray-400">The Literature Detective</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-col md:flex-row gap-4 mt-6 justify-center">
                        <button onclick="downloadCertificateImage()" class="modern-button px-6 py-3 text-lg rounded-2xl bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600">
                            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                        </button>
                        <button onclick="closeCertificateModal()" class="modern-button px-6 py-3 text-lg rounded-2xl bg-gray-500 hover:bg-gray-600">
                            ‡∏õ‡∏¥‡∏î
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close Certificate Modal
        function closeCertificateModal() {
            const modal = document.getElementById('certificateModal');
            if (modal) {
                modal.remove();
            }
        }

        // Download Certificate as Image
        function downloadCertificateImage() {
            try {
                const canvas = generateCertificate();
                
                // Convert to blob and download
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    const studentName = gameState.currentUser?.name || '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
                    const studentId = gameState.currentUser?.studentId || 'unknown';
                    const date = new Date().toLocaleDateString('th-TH').replace(/\//g, '-');
                    
                    a.download = `‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£_${studentName}_${studentId}_${date}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! üéâ', 'success');
                }, 'image/png', 0.95);
                
            } catch (error) {
                console.error('Error generating certificate:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£', 'error');
            }
        }

        // Calculate Final Score
        async function calculateFinalScore() {
            try {
                const mission = MISSION_DATA.MISSION_01;
                let vocabularyScore = 0;
                
                // Calculate vocabulary points
                Object.values(gameState.translatedWords).forEach(word => {
                    vocabularyScore += word.points;
                });
                
                // Comprehension bonus
                const comprehensionScore = gameState.comprehensionScore * 20;
                
                // Time bonus (max 50 points, decreases over time)
                const timeElapsed = (Date.now() - gameState.startTime) / 1000 / 60; // minutes
                const timeBonus = Math.max(0, Math.floor(50 - timeElapsed * 2));
                
                const total = vocabularyScore + comprehensionScore + timeBonus;
                
                // Update player profile
                playerProfile.exp += total;
                playerProfile.totalGamesPlayed += 1;
                if (total > playerProfile.bestScore) {
                    playerProfile.bestScore = total;
                }
                
                // Save updated player profile
                await saveUserDataAsync();
                
                // Save final game completion data
                await saveAllUserAnswers();
                
                const finalScore = {
                    vocabulary: vocabularyScore,
                    comprehension: comprehensionScore,
                    timeBonus: timeBonus,
                    total: total
                };
                
                return finalScore;
                
            } catch (error) {
                console.error('Error calculating final score:', error);
                return {
                    vocabulary: 0,
                    comprehension: 0,
                    timeBonus: 0,
                    total: 0
                };
            }
        }



        // Handle iframe load
        function handleIframeLoad() {
            const iframe = document.getElementById('dictionaryIframe');
            const fallback = document.getElementById('dictionaryFallback');
            
            if (iframe && fallback) {
                try {
                    // Try to access iframe content to check if it loaded properly
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc && iframeDoc.body && iframeDoc.body.innerHTML.trim() !== '') {
                        // iframe loaded successfully, hide fallback
                        fallback.style.display = 'none';
                        iframe.style.display = 'block';
                    } else {
                        // iframe didn't load properly, show fallback
                        showDictionaryFallback();
                    }
                } catch (e) {
                    // Cross-origin error means the site is blocking iframe
                    showDictionaryFallback();
                }
            }
        }

        // Show dictionary fallback
        function showDictionaryFallback() {
            const iframe = document.getElementById('dictionaryIframe');
            const fallback = document.getElementById('dictionaryFallback');
            
            if (iframe && fallback) {
                iframe.style.display = 'none';
                fallback.style.display = 'flex';
            }
        }

        // Auto-detect iframe blocking after 3 seconds
        setTimeout(() => {
            const iframe = document.getElementById('dictionaryIframe');
            if (iframe) {
                try {
                    // Try to access iframe content
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (!iframeDoc || !iframeDoc.body || iframeDoc.body.innerHTML.trim() === '') {
                        showDictionaryFallback();
                    }
                } catch (e) {
                    showDictionaryFallback();
                }
            }
        }, 3000);

        // Open Dictionary in New Tab
        function openDictionaryNewTab() {
            window.open('https://dictionary.orst.go.th/index.php', '_blank', 'noopener,noreferrer');
            showNotification('‡πÄ‡∏õ‡∏¥‡∏î‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß! üìñ', 'success');
        }

        // Show Quick Search Modal
        function showQuickSearch() {
            const modal = document.createElement('div');
            modal.id = 'quickSearchModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 max-w-2xl w-full animate-bounce-in relative">
                    <button onclick="closeQuickSearchModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold">√ó</button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πà‡∏ß‡∏ô</h2>
                        <p class="text-gray-600">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ</p>
                    </div>
                    
                    <div class="mb-6">
                        <input type="text" id="quickSearchInput" class="w-full modern-input p-4 text-lg" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." autofocus>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="searchInDictionary()" class="bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-3">
                            <span class="text-2xl">üìñ</span>
                            <div class="text-left">
                                <div class="font-bold">‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô</div>
                                <div class="text-sm opacity-90">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£</div>
                            </div>
                        </button>
                        
                        <button onclick="searchInGoogle()" class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-3">
                            <span class="text-2xl">üîç</span>
                            <div class="text-left">
                                <div class="font-bold">Google Search</div>
                                <div class="text-sm opacity-90">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô Google</div>
                            </div>
                        </button>
                        
                        <button onclick="searchInWikipedia()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-3">
                            <span class="text-2xl">üåê</span>
                            <div class="text-left">
                                <div class="font-bold">‡∏ß‡∏¥‡∏Å‡∏¥‡∏û‡∏µ‡πÄ‡∏î‡∏µ‡∏¢</div>
                                <div class="text-sm opacity-90">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏£‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
                            </div>
                        </button>
                        
                        <button onclick="searchInSanook()" class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-3">
                            <span class="text-2xl">üìö</span>
                            <div class="text-left">
                                <div class="font-bold">‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏™‡∏ô‡∏∏‡∏Å</div>
                                <div class="text-sm opacity-90">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="closeQuickSearchModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">
                            ‡∏õ‡∏¥‡∏î
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add enter key listener
            document.getElementById('quickSearchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchInDictionary();
                }
            });
        }

        // Close Quick Search Modal
        function closeQuickSearchModal() {
            const modal = document.getElementById('quickSearchModal');
            if (modal) {
                modal.remove();
            }
        }

        // Search functions
        function searchInDictionary() {
            const searchTerm = document.getElementById('quickSearchInput').value.trim();
            if (searchTerm) {
                window.open(`https://dictionary.orst.go.th/search.php?search=${encodeURIComponent(searchTerm)}`, '_blank', 'noopener,noreferrer');
                closeQuickSearchModal();
                showNotification(`‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${searchTerm}" ‡πÉ‡∏ô‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô`, 'success');
            } else {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'error');
            }
        }

        function searchInGoogle() {
            const searchTerm = document.getElementById('quickSearchInput').value.trim();
            if (searchTerm) {
                window.open(`https://www.google.com/search?q=${encodeURIComponent(searchTerm + ' ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢')}`, '_blank', 'noopener,noreferrer');
                closeQuickSearchModal();
                showNotification(`‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${searchTerm}" ‡πÉ‡∏ô Google`, 'success');
            } else {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'error');
            }
        }

        function searchInWikipedia() {
            const searchTerm = document.getElementById('quickSearchInput').value.trim();
            if (searchTerm) {
                window.open(`https://th.wikipedia.org/wiki/${encodeURIComponent(searchTerm)}`, '_blank', 'noopener,noreferrer');
                closeQuickSearchModal();
                showNotification(`‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${searchTerm}" ‡πÉ‡∏ô‡∏ß‡∏¥‡∏Å‡∏¥‡∏û‡∏µ‡πÄ‡∏î‡∏µ‡∏¢`, 'success');
            } else {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'error');
            }
        }

        function searchInSanook() {
            const searchTerm = document.getElementById('quickSearchInput').value.trim();
            if (searchTerm) {
                window.open(`https://www.sanook.com/dict/search/${encodeURIComponent(searchTerm)}`, '_blank', 'noopener,noreferrer');
                closeQuickSearchModal();
                showNotification(`‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${searchTerm}" ‡πÉ‡∏ô‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏™‡∏ô‡∏∏‡∏Å`, 'success');
            } else {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'error');
            }
        }

        // Show Alternative Dictionaries
        function showAlternativeDictionaries() {
            const modal = document.createElement('div');
            modal.id = 'alternativeDictionariesModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 max-w-2xl w-full animate-bounce-in relative">
                    <button onclick="closeAlternativeDictionariesModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold">√ó</button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">üìö ‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                        <p class="text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</p>
                    </div>
                    
                    <div class="space-y-4">
                        <button onclick="openLink('https://dictionary.orst.go.th/')" class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-4">
                            <span class="text-2xl">üìñ</span>
                            <div class="text-left">
                                <div class="font-bold">‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô</div>
                                <div class="text-sm opacity-90">‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£</div>
                            </div>
                        </button>
                        
                        <button onclick="openLink('https://th.wikipedia.org/')" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-4">
                            <span class="text-2xl">üåê</span>
                            <div class="text-left">
                                <div class="font-bold">‡∏ß‡∏¥‡∏Å‡∏¥‡∏û‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</div>
                                <div class="text-sm opacity-90">‡∏™‡∏≤‡∏£‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
                            </div>
                        </button>
                        
                        <button onclick="openLink('https://www.google.com/search?q=')" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-4">
                            <span class="text-2xl">üîç</span>
                            <div class="text-left">
                                <div class="font-bold">Google Search</div>
                                <div class="text-sm opacity-90">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
                            </div>
                        </button>
                        
                        <button onclick="openLink('https://www.sanook.com/dict/')" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-4">
                            <span class="text-2xl">üìö</span>
                            <div class="text-left">
                                <div class="font-bold">‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏™‡∏ô‡∏∏‡∏Å</div>
                                <div class="text-sm opacity-90">‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="closeAlternativeDictionariesModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">
                            ‡∏õ‡∏¥‡∏î
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close Alternative Dictionaries Modal
        function closeAlternativeDictionariesModal() {
            const modal = document.getElementById('alternativeDictionariesModal');
            if (modal) {
                modal.remove();
            }
        }

        // Open Link in New Tab
        function openLink(url) {
            window.open(url, '_blank', 'noopener,noreferrer');
            closeAlternativeDictionariesModal();
            showNotification('‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß! üîó', 'success');
        }

        // Show Word Hints
        function showWordHints() {
            const modal = document.createElement('div');
            modal.id = 'wordHintsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            const mission = MISSION_DATA.MISSION_01;
            const wordsArray = Object.entries(mission.hardWords);
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 max-w-4xl w-full max-h-90vh overflow-y-auto animate-bounce-in relative">
                    <button onclick="closeWordHintsModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold">√ó</button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">üí° ‡πÉ‡∏ö‡πâ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</h2>
                        <p class="text-gray-600">‡∏î‡∏π‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢</p>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        ${wordsArray.map(([word, data]) => `
                            <div class="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200 p-4 rounded-xl text-center hover:shadow-lg transition-all duration-200">
                                <img src="${getWordImage(word)}" alt="‡πÉ‡∏ö‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${word}" class="w-20 h-20 mx-auto rounded-lg border-2 border-blue-300 object-cover mb-3 shadow-md">
                                <div class="font-bold text-blue-900 text-lg mb-1">${word}</div>
                                <div class="text-xs text-blue-700">${data.points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                <div class="text-xs text-gray-600 mt-2">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="closeWordHintsModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">
                            ‡∏õ‡∏¥‡∏î
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close Word Hints Modal
        function closeWordHintsModal() {
            const modal = document.getElementById('wordHintsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Open Dictionary (Legacy function - now redirects to new tab)
        function openDictionary() {
            openDictionaryNewTab();
        }

        // Close Dictionary Modal
        function closeDictionaryModal() {
            const modal = document.getElementById('dictionaryModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show Kloang Info
        function showKloangInfo() {
            const modal = document.createElement('div');
            modal.id = 'kloangModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 max-w-4xl w-full max-h-90vh overflow-y-auto animate-bounce-in relative">
                    <button onclick="closeKloangModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold">√ó</button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">üìã ‡∏â‡∏±‡∏ô‡∏ó‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û</h2>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-blue-900 mb-4">‡∏Ñ‡∏ì‡∏∞</h3>
                            <div class="space-y-2 text-blue-800">
                                <p>‚Ä¢ ‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û 1 ‡∏ö‡∏ó‡∏°‡∏µ 4 ‡∏ö‡∏≤‡∏ó ‡πÇ‡∏î‡∏¢ 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠ 1 ‡∏ö‡∏≤‡∏ó ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏≤‡∏ó‡∏°‡∏µ 2 ‡∏ß‡∏£‡∏£‡∏Ñ</p>
                                <p>‚Ä¢ ‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà 1 ‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà 2 ‡πÅ‡∏•‡∏∞‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà 3 ‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡∏Ñ‡∏∑‡∏≠ ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏µ 5 ‡∏Ñ‡∏≥ ‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏á‡∏°‡∏µ 2 ‡∏Ñ‡∏≥</p>
                                <p>‚Ä¢ ‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà 4 ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏µ 5 ‡∏Ñ‡∏≥‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏µ 4 ‡∏Ñ‡∏≥</p>
                                <p>‚Ä¢ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô 1 ‡∏ö‡∏ó‡∏à‡∏∞‡∏°‡∏µ 30 ‡∏Ñ‡∏≥</p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-orange-900 mb-4 text-center">‡∏£‡∏π‡∏õ‡∏â‡∏±‡∏ô‡∏ó‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û</h3>
                            <div class="text-center">
                                <img src="https://img5.pic.in.th/file/secure-sv1/--04.png" alt="‡∏£‡∏π‡∏õ‡∏â‡∏±‡∏ô‡∏ó‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û" class="w-full max-w-3xl mx-auto rounded-xl border-2 border-orange-300 shadow-lg" onerror="this.src=''; this.alt='‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ'; this.style.display='none';">
                                <p class="text-orange-700 text-sm mt-3">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏â‡∏±‡∏ô‡∏ó‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÇ‡∏Ñ‡∏•‡∏á‡∏™‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ß‡∏£‡∏£‡∏ì‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡πÄ‡∏≠‡∏Å (‚óè) ‡πÇ‡∏ó (‚óè) ‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏∞ (‚óã)</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="closeKloangModal()" class="modern-button px-6 py-3 rounded-xl bg-gray-500 hover:bg-gray-600">‡∏õ‡∏¥‡∏î</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }



        // Close Kloang Modal
        function closeKloangModal() {
            const modal = document.getElementById('kloangModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close Tooltip
        function closeTooltip() {
            const tooltip = document.getElementById('wordTooltip');
            if (tooltip) {
                tooltip.remove();
            }
        }

        // Show Notification
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f039c8838b91b4',t:'MTc2MDU0MDg0Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
